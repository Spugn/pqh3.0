var oe=Object.defineProperty;var ie=(p,K,U)=>K in p?oe(p,K,{enumerable:!0,configurable:!0,writable:!0,value:U}):p[K]=U;var X=(p,K,U)=>(ie(p,typeof K!="symbol"?K+"":K,U),U);import{f as te,g as ae,c as J}from"./tslib.es6-94563206.js";import{e as R}from"./equipment.api-587d6b29.js";const Q=(()=>{function p(j,v,y="UNKNOWN",N={}){const h=JSON.parse(JSON.stringify(v)),o={};for(const n in j.required)I(n,j.required[n]);return o;function I(n,x){const E=R.recipe(n,y),q=R.fragmentID(n);if(h[n]&&!N[R.rarity(n)]){if(o[n]=x-h[n],o[n]<=0){o[n]=x,h[n]-=x;return}o[n]=h[n],x-=h[n],h[n]=0}if(!N[R.rarity(n)]&&E.required_pieces>0&&(o[q]=E.required_pieces*x+(o[q]||0)),!N[R.rarity(n)])for(const M of E.required_items)I(M,x)}}function K(j,v,y="UNKNOWN",N={}){const h=`api.project#check: (${y} | ${j.date})`;console.time(h);const o=p(j,v,y,N),I=JSON.parse(JSON.stringify(o));for(const n in o)o[n]-=v[n]||0,o[n]<=0&&delete o[n];return console.timeEnd(h),{success:Object.keys(o).length<=0,remaining:o,recipe:I}}function U(j,v,y="UNKNOWN",N={}){const h=`api.project#consume: (${y} | ${j.date})`;console.time(h);const o=JSON.parse(JSON.stringify(v)),I=p(j,v,y,N);for(const n in I)o[n]-=I[n],(o[n]<=0||isNaN(o[n]))&&delete o[n];return console.timeEnd(h),o}function m(j){const v={};for(const y of j)for(const N in y.required)v[N]=(v[N]||0)+y.required[N];return v}function L(j,v,y="UNKNOWN",N={}){const h=K(j,v,y,N),o={progress:-1,items:{current:0,max:0},fragments:{current:0,max:0},check:h};for(const I in h.recipe)o.items.max++,o.fragments.max+=h.recipe[I];if(h.success)return o.progress=100,o.items.current=o.items.max,o.fragments.current=o.fragments.max,o;for(const I in h.remaining)o.items.current++,o.fragments.current+=h.remaining[I];return o.items.current=o.items.max-o.items.current,o.fragments.current=o.fragments.max-o.fragments.current,o.progress=parseFloat((o.fragments.current/o.fragments.max*100).toFixed(2)),o}function V(j=0){const v={};if(j>0)for(let I=0;I<j&&Object.keys(v).length<j;I++)v[R.getRandomItem()]=10;const y=te.getRandomCharacter(),N=Math.floor(Math.random()*te.getMaxRank())+1,h=Math.floor(Math.random()*N)+1;return{type:"character",date:Date.now(),priority:!1,details:{avatar_id:y.id,formal_name:`${y.name.JP} (${y.id})`,name:y.name.JP,start:{rank:h,equipment:o()},end:{rank:N,equipment:o()},memory_piece:0,pure_memory_piece:0,ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:v};function o(){return[Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5]}}function B(j=0){const v={};if(j>0)for(let y=0;y<j&&Object.keys(v).length<j;y++)v[R.getRandomItem()]=10;return{type:"item",date:Date.now(),priority:!1,details:{name:"Untitled Project",ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:v}}return{build:p,check:K,consume:U,compile:m,progress:L,getTestCharacterProject:V,getTestItemProject:B}})();class Y{}X(Y,"max_chapter",-1);const Z=(()=>{const p=ae.quest;function K(t){return p[t]}function U(t,l){var c,r,a,u,_;if(p[t])return l?((a=(r=p[t])==null?void 0:r.name)==null?void 0:a[l])||((_=(u=p[t])==null?void 0:u.name)==null?void 0:_.JP):(c=p[t])==null?void 0:c.name}function m(t,l){var c,r,a,u,_;if(p[t])return l?((a=(r=p[t])==null?void 0:r.stamina)==null?void 0:a[l])||((_=(u=p[t])==null?void 0:u.stamina)==null?void 0:_.JP):(c=p[t])==null?void 0:c.stamina}function L(t,l){var a,u;const c=(a=p[t])==null?void 0:a.drop_table[l],r=c?c.memory_piece:(u=p[t])==null?void 0:u.drop_table.JP.memory_piece;return r&&r.item!==J.placeholder_id?r:void 0}function V(t,l){var a,u;const c=(a=p[t])==null?void 0:a.drop_table[l];return(c?c.drops:(u=p[t])==null?void 0:u.drop_table.JP.drops)||[]}function B(t,l){var a,u;const c=(a=p[t])==null?void 0:a.drop_table[l];return(c?c.subdrops:(u=p[t])==null?void 0:u.drop_table.JP.subdrops)||[]}function j(t){return t!==""&&!t.includes(J.difficulty.hard)&&!t.includes(J.difficulty.event)}function v(t){return t.includes(J.difficulty.hard)&&!t.includes(J.difficulty.very_hard)}function y(t){return t.includes(J.difficulty.very_hard)}function N(t){return t.includes(J.difficulty.event)}function h(t){return parseInt(t.split("-")[0])}function o(t){return parseInt(t.split("-")[1])}function I(){if(Y.max_chapter===-1){let t=-1;for(const l in p){const c=h(l);t=Math.max(t,c)}Y.max_chapter=t}return Y.max_chapter}function n(t){return p[t]!==void 0}function x({all_projects:t,compiled_items:l,inventory:c,settings:r={},use_inventory:a=!1,language:u="UNKNOWN"}){const _=`api.quest#build: (${u} | ${Date.now().toLocaleString()})`;console.time(_);let P,s;if(a){const O=Q.check({date:"quest-build",required:l},c,u,r.ignored_rarities);P=O.remaining,s=O.recipe}else P=s=Q.build({date:"quest-build",required:l},{},u,r.ignored_rarities);if(Object.keys(P).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(_),{required:P,required_clean:s,quest_scores:[],priority_items:[],priority_amount:{}};let f=new Set,g={};for(const O of t)if(O.priority)for(const A in O.required)R.exists(A)&&(f.add(A),g[A]=(g[A]||0)+O.required[A]);const $=Array.from(f).reduce((O,A)=>(O[A]=g[A],O),{});g=Q.build({date:"quest-build",required:$},{},u,{});const S=Object.keys(g),k=M({required:P,priority_items:S,priority_levels:{},settings:r,language:u});return console.timeEnd(_),{required:P,required_clean:s,quest_scores:k,priority_items:S,priority_amount:g}}function E({session_projects:t,inventory:l,settings:c,use_inventory:r=!1,language:a}){var w;l||(l=ee.inventory.get()),c||(c=ee.settings.quest.get()),a||(a=ee.region.get());const u=`api.quest#build2: (${a} | ${Date.now().toLocaleString()})`;console.time(u);const _=Object.keys(t).filter(C=>t[C].enabled).map(C=>t[C].project),P=Q.compile(_);let s,f;if(r){const C=Q.check({date:"quest-build-with-inventory",required:P},l,a,c.ignored_rarities);s=C.remaining,f=C.recipe}else s=f=Q.build({date:"quest-build-no-inventory",required:P},{},a,c.ignored_rarities);if(Object.keys(s).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(u),{required:s,required_clean:f,quest_scores:[],priority_items:[],priority_amount:{},projects:_};let g={},$=new Set,S={};for(const C in t){const T=t[C].project;if(T.priority)for(const W in T.required){if(!R.exists(W))continue;const G=((w=T.details)==null?void 0:w.priority_level)||2;g[W]=g[W]&&g[W]>G?g[W]:G,$.add(W),S[W]=(S[W]||0)+T.required[W]}}const k=Array.from($).reduce((C,T)=>(C[T]=S[T],C),{}),O=q(k,g,a),A=Object.keys(O.priority_amount),z=M({required:s,priority_items:A,priority_levels:O.priority_levels,settings:c,language:a});return console.timeEnd(u),{required:s,required_clean:f,quest_scores:z,priority_items:A,priority_amount:S,projects:_}}function q(t,l,c="UNKNOWN"){const r={},a={};for(const _ in t)u(_,t[_],l[_]);return{priority_amount:r,priority_levels:a};function u(_,P,s){const f=R.recipe(_,c),g=R.fragmentID(_);f.required_pieces>0&&(r[g]=f.required_pieces*P+(r[g]||0),a[g]=a[g]&&a[g]>s?a[g]:s);for(const $ of f.required_items)u($,P,s)}}function M({required:t,priority_items:l,priority_levels:c,settings:r={},language:a="UNKNOWN"}){var _,P,s;let u=[];for(const f in p){let g=function(k){if(!k||!t.hasOwnProperty(k.item))return 0;let O=k.drop_rate;return O*=l.includes(k.item)?c[k.item]:1,O+=t[k.item]/J.inventory.max.fragment*1e3,O};const $=h(f);if(r.chapter&&($<r.chapter.min||$>r.chapter.max)||r.disabled_difficulty&&(r.disabled_difficulty.Normal&&j(f)||r.disabled_difficulty.Hard&&v(f)||r.disabled_difficulty["Very Hard"]&&y(f)||r.disabled_difficulty.Event&&N(f)))continue;if(r.item_filter&&r.item_filter.length>0){let k=!1;for(const O of r.item_filter)if(F(O,f,a)){k=!0;break}if(!k)continue}let S=0;S+=g(L(f,a));for(const k of V(f,a))S+=g(k);for(const k of B(f,a))S+=g(k);if(j(f)&&((_=r==null?void 0:r.drop_buff)!=null&&_.Normal)&&(S*=r.drop_buff.Normal),v(f)&&((P=r==null?void 0:r.drop_buff)!=null&&P.Hard)&&(S*=r.drop_buff.Hard),y(f)&&((s=r==null?void 0:r.drop_buff)!=null&&s["Very Hard"])&&(S*=r.drop_buff["Very Hard"]),S>0){const k=m(f,a);typeof k=="number"&&(S/=k),u.push({id:f,score:+S.toFixed(2)})}}return u.sort((f,g)=>{const $={id:f.id,chapter:h(f.id),number:o(f.id),value:0},S={id:g.id,chapter:h(g.id),number:o(g.id),value:0};function k(w){y(w.id)&&(w.value+=2e3),(v(w.id)||N(w.id))&&(w.value+=1e3),w.value+=w.chapter*1e4+w.number*10}function O(w,C){return w-C}function A(w,C){return C-w}k($),k(S);let z=r.sort&&r.sort.score?O(f.score,g.score):A(f.score,g.score);return z!==0?z:r.sort&&r.sort.list?A($.value,S.value):O($.value,S.value)}),u}function F(t,l,c){let r,a;if(R.exists(t)?(r=t,a=R.fragment(t)):(r=R.convertFragmentID(t),a=t),r===J.placeholder_id)return!1;const u=L(l,c);if((u==null?void 0:u.item)===r)return!0;for(const _ of V(l,c))if(_.item===r||_.item===a)return!0;for(const _ of B(l,c))if(_.item===r||_.item===a)return!0;return!1}function i(t){console.time("quest.estimate");const c=Q.build({required:t},{});let r=0;for(const a in p){let u=function(_){const P=L(a,"JP");if(P&&c.hasOwnProperty(P.item))return++_;for(const s of V(a,"JP"))if(c.hasOwnProperty(s.item))return++_;for(const s of B(a,"JP"))if(c.hasOwnProperty(s.item))return++_;return _};if(r>=100)break;r=u(r)}return console.timeEnd("quest.estimate"),r}function D(t,l){return n(t)&&K(t).name[l]!==void 0}return{data:p,get:K,name:U,stamina:m,memoryPiece:L,drops:V,subdrops:B,isNormal:j,isHard:v,isVeryHard:y,isEvent:N,getChapter:h,getNumber:o,getMaxChapter:I,exists:n,build:x,build2:E,search:M,checkForItem:F,estimate:i,existsInRegion:D}})();class e{}X(e,"is_init"),X(e,"user_state"),X(e,"force_no_localstorage"),X(e,"projects",{}),X(e,"create_project_ignored_rarities",{});const ee=(()=>{function p(){if(!V()){if(L()){localStorage.getItem(J.legacy_localstorage_key)?(console.log("importing old settings"),K()):localStorage.getItem(J.localstorage_key)===null?(console.log("init new user"),e.user_state=JSON.parse(JSON.stringify(J.default_user_state)),m()):(console.log("loading user from localstorage"),e.user_state=JSON.parse(localStorage.getItem(J.localstorage_key))),e.is_init=!0;return}console.warn("localstorage is not supported on this browser, using basic state"),e.user_state=JSON.parse(JSON.stringify(J.default_user_state)),e.is_init=!0}}function K(){var E;const n=JSON.parse(localStorage.getItem(J.legacy_localstorage_key));e.user_state=JSON.parse(JSON.stringify(J.default_user_state));for(const q in n.character){const M=n.character[q];e.user_state.character[q]={...M,id:q}}e.user_state.inventory=n.inventory;for(const q of n.projects){let M={};q.details.ignored_rarity&&(M=JSON.parse(JSON.stringify(q.details.ignored_rarity)),delete q.details.ignored_rarity),e.user_state.projects[q.date]={type:q.type,date:parseInt(q.date),priority:q.priority,details:{...q.details,ignored_rarities:M,...!q.details.memory_piece&&{memory_piece:0},...!q.details.pure_memory_piece&&{pure_memory_piece:0}},required:q.required}}e.user_state.settings.region=n.settings.region;let x={};n.settings.quest.ignored_rarity&&(x=JSON.parse(JSON.stringify(n.settings.quest.ignored_rarity)),delete n.settings.quest.ignored_rarity),e.user_state.settings.quest=n.settings.quest,e.user_state.settings.quest.ignored_rarities=x,(E=e.user_state.settings.quest.chapter)!=null&&E.max&&Z.getMaxChapter()<n.settings.quest.chapter.max&&(e.user_state.settings.quest.chapter.max=Z.getMaxChapter(),e.user_state.settings.quest.chapter.min&&e.user_state.settings.quest.chapter.min>e.user_state.settings.quest.chapter.max&&(e.user_state.settings.quest.chapter.min=e.user_state.settings.quest.chapter.max)),m(),localStorage.removeItem(J.legacy_localstorage_key)}function U(){return e.user_state||p(),e.user_state}function m(){if(!L()){console.log("local storage not supported, cant save");return}localStorage.setItem(J.localstorage_key,JSON.stringify(e.user_state)),console.log("saved user state",e.user_state)}function L(){return typeof Storage<"u"&&!e.force_no_localstorage}function V(){return e.is_init}function B(){return e.projects}function j(){return e.create_project_ignored_rarities}function v(){e.force_no_localstorage=!e.force_no_localstorage}const y=(()=>{function n(i){e.user_state.inventory=i,m()}function x(i,D){D<=0?delete e.user_state.inventory[i]:e.user_state.inventory[i]=D>=J.inventory.max.fragment?J.inventory.max.fragment:D,m()}function E(){return e.user_state.inventory}function q(i){return e.user_state.inventory[i]||0}function M(i,D){x(i,q(i)+D)}function F(i){delete e.user_state.inventory[i],m()}return{set:n,setAmount:x,get:E,getAmount:q,remove:F,addAmount:M}})(),N=(()=>{function n(i){e.user_state.character=i,m()}function x(){return e.user_state.character}function E(i,D,t){e.user_state.character={...e.user_state.character,[i]:e.user_state.character[i]||{id:i},[i]:{...e.user_state.character[i],rank:D,equipment:t}},m()}function q(i){return e.user_state.character[i]}function M(i){return e.user_state.character[i]!==void 0}function F(i){M(i)&&(delete e.user_state.character[i],m())}return{set:n,get:x,setCharacter:E,getCharacter:q,exists:M,remove:F}})(),h=(()=>{function n(s,f){e.user_state.settings={...e.user_state.settings,[s]:f},m()}function x(s){e.user_state.settings=s,m()}function E(){return e.user_state.settings}function q(){return e.user_state.settings.hide_content||!1}function M(s){n("hide_content",s)}function F(){return e.user_state.settings.compact_project_cards||!1}function i(s){n("compact_project_cards",s)}function D(){return e.user_state.settings.auto_enable_projects||!1}function t(s){n("auto_enable_projects",s)}function l(){return e.user_state.settings.keep_enabled_projects!==void 0&&e.user_state.settings.keep_enabled_projects.enabled}function c(s){if(!e.user_state.settings.keep_enabled_projects||s){let f={};for(const g in e.projects)e.projects[g].enabled&&(f[`${e.projects[g].project.date}`]=!0);n("keep_enabled_projects",{enabled:!0,projects:f});return}delete e.user_state.settings.keep_enabled_projects,m()}function r(s){e.user_state.settings.keep_enabled_projects&&(e.user_state.settings.keep_enabled_projects.projects=s,m())}function a(){return e.user_state.settings.keep_enabled_projects?e.user_state.settings.keep_enabled_projects.projects:{}}function u(){return e.user_state.settings.inventory_alternative_mode||!1}function _(s){n("inventory_alternative_mode",s)}const P=(()=>{function s(){return e.user_state.settings.quest||(e.user_state.settings.quest={}),e.user_state.settings.quest}function f(){return s()}function g(d,b){const H=s();H.chapter={min:d,max:b,auto_max:b===Z.getMaxChapter()},m()}function $(){return s().chapter}function S(d){const b=s();if(b.disabled_difficulty||(b.disabled_difficulty={}),b.disabled_difficulty[d]){delete b.disabled_difficulty[d],m();return}b.disabled_difficulty[d]=!0,m()}function k(){return s().disabled_difficulty}function O(d){var b;return((b=k())==null?void 0:b[d])||!1}function A(d){const b=s();b.item_filter=d,m()}function z(){return s().item_filter||[]}function w(d,b){const H=s();if(H.drop_buff||(H.drop_buff={}),b===1){delete H.drop_buff[d],m();return}H.drop_buff[d]=b,m()}function C(d){var H;return((H=s().drop_buff)==null?void 0:H[d])||1}function T(){const d=s();if(d.sort||(d.sort={}),d.sort.list){delete d.sort.list,m();return}d.sort.list=!0,m()}function W(){var b;return((b=s().sort)==null?void 0:b.list)||!1}function G(){const d=s();if(d.sort||(d.sort={}),d.sort.score){delete d.sort.score,m();return}d.sort.score=!0,m()}function re(){var b;return((b=s().sort)==null?void 0:b.score)||!1}function ne(d){const b=s();if(b.ignored_rarities||(b.ignored_rarities={}),b.ignored_rarities[d]){delete b.ignored_rarities[d],m();return}b.ignored_rarities[d]=!0,m()}function se(d){var H;return((H=s().ignored_rarities)==null?void 0:H[d])||!1}return{get:f,setChapterRange:g,getChapterRange:$,disableDifficulty:S,getDisabledDifficulties:k,isDisabledDifficulty:O,setItemFilter:A,getItemFilter:z,setDropBuff:w,getDropBuff:C,toggleListSort:T,getListSort:W,toggleScoreSort:G,getScoreSort:re,ignoreRarity:ne,isRarityIgnored:se}})();return{set:n,setAll:x,get:E,hideContent:q,setHideContent:M,isCompactProjectCards:F,setCompactProjectCards:i,isAutoEnableProjects:D,setAutoEnableProjects:t,isInventoryAlternativeMode:u,setInventoryAlternativeMode:_,isKeepEnabledProjects:l,setKeepEnabledProjectsEnabledState:c,setKeepEnabledProjectsEnabledProjects:r,getKeepEnabledProjectsEnabledProjects:a,quest:P}})(),o=(()=>{function n(i){e.user_state.projects=i,m()}function x(){return e.user_state.projects}function E(i){e.user_state.projects[i.date||Date.now()]=i,m()}function q(i,D){e.user_state.projects[i]&&(e.user_state.projects[i]=D,m())}function M(i){delete e.user_state.projects[i],m()}function F(i,D={}){if(!e.user_state.projects[i.date])return;let t=D.consume?Q.consume(i,y.get(),h.get().region,i.details.ignored_rarities):y.get();if(D.save&&i.type==="character"){const l=i.details.avatar_id,c=N.get();N.set({...c,[l]:{id:l,rank:i.details.end.rank,equipment:i.details.end.equipment}}),y.set(t),M(i.date);return}y.set(t),M(i.date)}return{set:n,get:x,add:E,replace:q,delete:M,complete:F}})(),I=(()=>{function n(E){e.user_state.settings.region=E,m()}function x(){return e.user_state.settings.region||"UNKNOWN"}return{set:n,get:x}})();return{init:p,get:U,save:m,isInit:V,_toggle_localstorage:v,getSessionProjects:B,getSessionIgnoredRarities:j,inventory:y,character:N,settings:h,projects:o,region:I}})();export{Q as p,Z as q,ee as u};
