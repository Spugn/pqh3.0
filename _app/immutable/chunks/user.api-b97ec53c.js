var Z=Object.defineProperty;var ee=(_,$,K)=>$ in _?Z(_,$,{enumerable:!0,configurable:!0,writable:!0,value:K}):_[$]=K;var B=(_,$,K)=>(ee(_,typeof $!="symbol"?$+"":$,K),K);import{f as Y,g as te,c as I}from"./tslib.es6-74f82098.js";import{e as U}from"./equipment.api-0e86ba89.js";const T=(()=>{function _(v,b,g="UNKNOWN",S={}){const h=JSON.parse(JSON.stringify(b)),i={};for(const s in v.required)P(s,v.required[s]);return i;function P(s,M){const w=U.recipe(s,g),q=U.fragmentID(s);if(h[s]&&!S[U.rarity(s)]){if(i[s]=M-h[s],i[s]<=0){i[s]=M,h[s]-=M;return}i[s]=h[s],M-=h[s],h[s]=0}if(!S[U.rarity(s)]&&w.required_pieces>0&&(i[q]=w.required_pieces*M+(i[q]||0)),!S[U.rarity(s)])for(const J of w.required_items)P(J,M)}}function $(v,b,g="UNKNOWN",S={}){const h=`api.project#check: (${g} | ${v.date})`;console.time(h);const i=_(v,b,g,S),P=JSON.parse(JSON.stringify(i));for(const s in i)i[s]-=b[s]||0,i[s]<=0&&delete i[s];return console.timeEnd(h),{success:Object.keys(i).length<=0,remaining:i,recipe:P}}function K(v,b,g="UNKNOWN",S={}){const h=`api.project#consume: (${g} | ${v.date})`;console.time(h);const i=JSON.parse(JSON.stringify(b)),P=_(v,b,g,S);for(const s in P)i[s]-=P[s],(i[s]<=0||isNaN(i[s]))&&delete i[s];return console.timeEnd(h),i}function p(v){const b={};for(const g of v)for(const S in g.required)b[S]=(b[S]||0)+g.required[S];return b}function F(v,b,g="UNKNOWN",S={}){const h=$(v,b,g,S),i={progress:-1,items:{current:0,max:0},fragments:{current:0,max:0},check:h};for(const P in h.recipe)i.items.max++,i.fragments.max+=h.recipe[P];if(h.success)return i.progress=100,i.items.current=i.items.max,i.fragments.current=i.fragments.max,i;for(const P in h.remaining)i.items.current++,i.fragments.current+=h.remaining[P];return i.items.current=i.items.max-i.items.current,i.fragments.current=i.fragments.max-i.fragments.current,i.progress=parseFloat((i.fragments.current/i.fragments.max*100).toFixed(2)),i}function L(v=0){const b={};if(v>0)for(let P=0;P<v&&Object.keys(b).length<v;P++)b[U.getRandomItem()]=10;const g=Y.getRandomCharacter(),S=Math.floor(Math.random()*Y.getMaxRank())+1,h=Math.floor(Math.random()*S)+1;return{type:"character",date:Date.now(),priority:!1,details:{avatar_id:g.id,formal_name:`${g.name.JP} (${g.id})`,name:g.name.JP,start:{rank:h,equipment:i()},end:{rank:S,equipment:i()},memory_piece:0,pure_memory_piece:0,ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:b};function i(){return[Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5]}}function V(v=0){const b={};if(v>0)for(let g=0;g<v&&Object.keys(b).length<v;g++)b[U.getRandomItem()]=10;return{type:"item",date:Date.now(),priority:!1,details:{name:"Untitled Project",ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:b}}return{build:_,check:$,consume:K,compile:p,progress:F,getTestCharacterProject:L,getTestItemProject:V}})();class X{}B(X,"max_chapter",-1);const z=(()=>{const _=te.quest;function $(e){return _[e]}function K(e,d){var n,r,a,f,l;if(_[e])return d?((a=(r=_[e])==null?void 0:r.name)==null?void 0:a[d])||((l=(f=_[e])==null?void 0:f.name)==null?void 0:l.JP):(n=_[e])==null?void 0:n.name}function p(e,d){var n,r,a,f,l;if(_[e])return d?((a=(r=_[e])==null?void 0:r.stamina)==null?void 0:a[d])||((l=(f=_[e])==null?void 0:f.stamina)==null?void 0:l.JP):(n=_[e])==null?void 0:n.stamina}function F(e,d){var a,f;const n=(a=_[e])==null?void 0:a.drop_table[d],r=n?n.memory_piece:(f=_[e])==null?void 0:f.drop_table.JP.memory_piece;return r&&r.item!==I.placeholder_id?r:void 0}function L(e,d){var a,f;const n=(a=_[e])==null?void 0:a.drop_table[d];return(n?n.drops:(f=_[e])==null?void 0:f.drop_table.JP.drops)||[]}function V(e,d){var a,f;const n=(a=_[e])==null?void 0:a.drop_table[d];return(n?n.subdrops:(f=_[e])==null?void 0:f.drop_table.JP.subdrops)||[]}function v(e){return e!==""&&!e.includes(I.difficulty.hard)&&!e.includes(I.difficulty.event)}function b(e){return e.includes(I.difficulty.hard)&&!e.includes(I.difficulty.very_hard)}function g(e){return e.includes(I.difficulty.very_hard)}function S(e){return e.includes(I.difficulty.event)}function h(e){return parseInt(e.split("-")[0])}function i(e){return parseInt(e.split("-")[1])}function P(){if(X.max_chapter===-1){let e=-1;for(const d in _){const n=h(d);e=Math.max(e,n)}X.max_chapter=e}return X.max_chapter}function s(e){return _[e]!==void 0}function M({all_projects:e,compiled_items:d,inventory:n,settings:r={},use_inventory:a=!1,language:f="UNKNOWN"}){const l=`api.quest#build: (${f} | ${Date.now().toLocaleString()})`;console.time(l);let j,N;if(a){const x=T.check({date:"quest-build",required:d},n,f,r.ignored_rarities);j=x.remaining,N=x.recipe}else j=N=T.build({date:"quest-build",required:d},{},f,r.ignored_rarities);if(Object.keys(j).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(l),{required:j,required_clean:N,quest_scores:[],priority_items:[],priority_amount:{}};let m=new Set,y={};for(const x of e)if(x.priority)for(const E in x.required)U.exists(E)&&(m.add(E),y[E]=(y[E]||0)+x.required[E]);const H=Array.from(m).reduce((x,E)=>(x[E]=y[E],x),{});y=T.build({date:"quest-build",required:H},{},f,{});const O=Object.keys(y),k=J({required:j,priority_items:O,priority_levels:{},settings:r,language:f});return console.timeEnd(l),{required:j,required_clean:N,quest_scores:k,priority_items:O,priority_amount:y}}function w({session_projects:e,inventory:d,settings:n,use_inventory:r=!1,language:a}){var D;d||(d=G.inventory.get()),n||(n=G.settings.quest.get()),a||(a=G.region.get());const f=`api.quest#build2: (${a} | ${Date.now().toLocaleString()})`;console.time(f);const l=Object.keys(e).filter(A=>e[A].enabled).map(A=>e[A].project),j=T.compile(l);let N,m;if(r){const A=T.check({date:"quest-build-with-inventory",required:j},d,a,n.ignored_rarities);N=A.remaining,m=A.recipe}else N=m=T.build({date:"quest-build-no-inventory",required:j},{},a,n.ignored_rarities);if(Object.keys(N).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(f),{required:N,required_clean:m,quest_scores:[],priority_items:[],priority_amount:{},projects:l};let y={},H=new Set,O={};for(const A in e){const c=e[A].project;if(c.priority)for(const u in c.required){if(!U.exists(u))continue;const R=((D=c.details)==null?void 0:D.priority_level)||2;y[u]=y[u]&&y[u]>R?y[u]:R,H.add(u),O[u]=(O[u]||0)+c.required[u]}}const k=Array.from(H).reduce((A,c)=>(A[c]=O[c],A),{}),x=q(k,y,a),E=Object.keys(x.priority_amount),Q=J({required:N,priority_items:E,priority_levels:x.priority_levels,settings:n,language:a});return console.timeEnd(f),{required:N,required_clean:m,quest_scores:Q,priority_items:E,priority_amount:O,projects:l}}function q(e,d,n="UNKNOWN"){const r={},a={};for(const l in e)f(l,e[l],d[l]);return{priority_amount:r,priority_levels:a};function f(l,j,N){const m=U.recipe(l,n),y=U.fragmentID(l);m.required_pieces>0&&(r[y]=m.required_pieces*j+(r[y]||0),a[y]=a[y]&&a[y]>N?a[y]:N);for(const H of m.required_items)f(H,j,N)}}function J({required:e,priority_items:d,priority_levels:n,settings:r={},language:a="UNKNOWN"}){var l,j,N;let f=[];for(const m in _){let y=function(k){if(!k||!e.hasOwnProperty(k.item))return 0;let x=k.drop_rate;return x*=d.includes(k.item)?n[k.item]:1,x+=e[k.item]/I.inventory.max.fragment*1e3,x};const H=h(m);if(r.chapter&&(H<r.chapter.min||H>r.chapter.max)||r.disabled_difficulty&&(r.disabled_difficulty.Normal&&v(m)||r.disabled_difficulty.Hard&&b(m)||r.disabled_difficulty["Very Hard"]&&g(m)||r.disabled_difficulty.Event&&S(m)))continue;if(r.item_filter&&r.item_filter.length>0){let k=!1;for(const x of r.item_filter)if(W(x,m,a)){k=!0;break}if(!k)continue}let O=0;O+=y(F(m,a));for(const k of L(m,a))O+=y(k);for(const k of V(m,a))O+=y(k);if(v(m)&&((l=r==null?void 0:r.drop_buff)!=null&&l.Normal)&&(O*=r.drop_buff.Normal),b(m)&&((j=r==null?void 0:r.drop_buff)!=null&&j.Hard)&&(O*=r.drop_buff.Hard),g(m)&&((N=r==null?void 0:r.drop_buff)!=null&&N["Very Hard"])&&(O*=r.drop_buff["Very Hard"]),O>0){const k=p(m,a);typeof k=="number"&&(O/=k),f.push({id:m,score:+O.toFixed(2)})}}return f.sort((m,y)=>{const H={id:m.id,chapter:h(m.id),number:i(m.id),value:0},O={id:y.id,chapter:h(y.id),number:i(y.id),value:0};function k(D){g(D.id)&&(D.value+=2e3),(b(D.id)||S(D.id))&&(D.value+=1e3),D.value+=D.chapter*1e4+D.number*10}function x(D,A){return D-A}function E(D,A){return A-D}k(H),k(O);let Q=r.sort&&r.sort.score?x(m.score,y.score):E(m.score,y.score);return Q!==0?Q:r.sort&&r.sort.list?E(H.value,O.value):x(H.value,O.value)}),f}function W(e,d,n){let r,a;if(U.exists(e)?(r=e,a=U.fragment(e)):(r=U.convertFragmentID(e),a=e),r===I.placeholder_id)return!1;const f=F(d,n);if((f==null?void 0:f.item)===r)return!0;for(const l of L(d,n))if(l.item===r||l.item===a)return!0;for(const l of V(d,n))if(l.item===r||l.item===a)return!0;return!1}function o(e){console.time("quest.estimate");const n=T.build({required:e},{});let r=0;for(const a in _){let f=function(l){const j=F(a,"JP");if(j&&n.hasOwnProperty(j.item))return++l;for(const N of L(a,"JP"))if(n.hasOwnProperty(N.item))return++l;for(const N of V(a,"JP"))if(n.hasOwnProperty(N.item))return++l;return l};if(r>=100)break;r=f(r)}return console.timeEnd("quest.estimate"),r}function C(e,d){return s(e)&&$(e).name[d]!==void 0}return{data:_,get:$,name:K,stamina:p,memoryPiece:F,drops:L,subdrops:V,isNormal:v,isHard:b,isVeryHard:g,isEvent:S,getChapter:h,getNumber:i,getMaxChapter:P,exists:s,build:M,build2:w,search:J,checkForItem:W,estimate:o,existsInRegion:C}})();class t{}B(t,"is_init"),B(t,"user_state"),B(t,"force_no_localstorage"),B(t,"projects",{}),B(t,"create_project_ignored_rarities",{});const G=(()=>{function _(){if(!L()){if(F()){localStorage.getItem(I.legacy_localstorage_key)?(console.log("importing old settings"),$()):localStorage.getItem(I.localstorage_key)===null?(console.log("init new user"),t.user_state=JSON.parse(JSON.stringify(I.default_user_state)),p()):(console.log("loading user from localstorage"),t.user_state=JSON.parse(localStorage.getItem(I.localstorage_key))),t.is_init=!0;return}console.warn("localstorage is not supported on this browser, using basic state"),t.user_state=JSON.parse(JSON.stringify(I.default_user_state)),t.is_init=!0}}function $(){var w;const s=JSON.parse(localStorage.getItem(I.legacy_localstorage_key));t.user_state=JSON.parse(JSON.stringify(I.default_user_state));for(const q in s.character){const J=s.character[q];t.user_state.character[q]={...J,id:q}}t.user_state.inventory=s.inventory;for(const q of s.projects){let J={};q.details.ignored_rarity&&(J=JSON.parse(JSON.stringify(q.details.ignored_rarity)),delete q.details.ignored_rarity),t.user_state.projects[q.date]={type:q.type,date:parseInt(q.date),priority:q.priority,details:{...q.details,ignored_rarities:J,...!q.details.memory_piece&&{memory_piece:0},...!q.details.pure_memory_piece&&{pure_memory_piece:0}},required:q.required}}t.user_state.settings.region=s.settings.region;let M={};s.settings.quest.ignored_rarity&&(M=JSON.parse(JSON.stringify(s.settings.quest.ignored_rarity)),delete s.settings.quest.ignored_rarity),t.user_state.settings.quest=s.settings.quest,t.user_state.settings.quest.ignored_rarities=M,(w=t.user_state.settings.quest.chapter)!=null&&w.max&&z.getMaxChapter()<s.settings.quest.chapter.max&&(t.user_state.settings.quest.chapter.max=z.getMaxChapter(),t.user_state.settings.quest.chapter.min&&t.user_state.settings.quest.chapter.min>t.user_state.settings.quest.chapter.max&&(t.user_state.settings.quest.chapter.min=t.user_state.settings.quest.chapter.max)),p(),localStorage.removeItem(I.legacy_localstorage_key)}function K(){return t.user_state||_(),t.user_state}function p(){if(!F()){console.log("local storage not supported, cant save");return}localStorage.setItem(I.localstorage_key,JSON.stringify(t.user_state)),console.log("saved user state",t.user_state)}function F(){return typeof Storage<"u"&&!t.force_no_localstorage}function L(){return t.is_init}function V(){return t.projects}function v(){return t.create_project_ignored_rarities}function b(){t.force_no_localstorage=!t.force_no_localstorage}const g=(()=>{function s(o){t.user_state.inventory=o,p()}function M(o,C){C<=0?delete t.user_state.inventory[o]:t.user_state.inventory[o]=C>=I.inventory.max.fragment?I.inventory.max.fragment:C,p()}function w(){return t.user_state.inventory}function q(o){return t.user_state.inventory[o]||0}function J(o,C){M(o,q(o)+C)}function W(o){delete t.user_state.inventory[o],p()}return{set:s,setAmount:M,get:w,getAmount:q,remove:W,addAmount:J}})(),S=(()=>{function s(o){t.user_state.character=o,p()}function M(){return t.user_state.character}function w(o,C,e){t.user_state.character={...t.user_state.character,[o]:t.user_state.character[o]||{id:o},[o]:{...t.user_state.character[o],rank:C,equipment:e}},p()}function q(o){return t.user_state.character[o]}function J(o){return t.user_state.character[o]!==void 0}function W(o){J(o)&&(delete t.user_state.character[o],p())}return{set:s,get:M,setCharacter:w,getCharacter:q,exists:J,remove:W}})(),h=(()=>{function s(n,r){t.user_state.settings={...t.user_state.settings,[n]:r},p()}function M(n){t.user_state.settings=n,p()}function w(){return t.user_state.settings}function q(){return t.user_state.settings.hide_content||!1}function J(n){s("hide_content",n)}function W(){return t.user_state.settings.auto_enable_projects||!1}function o(n){s("auto_enable_projects",n)}function C(){return t.user_state.settings.inventory_alternative_mode||!1}function e(n){s("inventory_alternative_mode",n)}const d=(()=>{function n(){return t.user_state.settings.quest||(t.user_state.settings.quest={}),t.user_state.settings.quest}function r(){return n()}function a(c,u){const R=n();R.chapter={min:c,max:u,auto_max:u===z.getMaxChapter()},p()}function f(){return n().chapter}function l(c){const u=n();if(u.disabled_difficulty||(u.disabled_difficulty={}),u.disabled_difficulty[c]){delete u.disabled_difficulty[c],p();return}u.disabled_difficulty[c]=!0,p()}function j(){return n().disabled_difficulty}function N(c){var u;return((u=j())==null?void 0:u[c])||!1}function m(c){const u=n();u.item_filter=c,p()}function y(){return n().item_filter||[]}function H(c,u){const R=n();if(R.drop_buff||(R.drop_buff={}),u===1){delete R.drop_buff[c],p();return}R.drop_buff[c]=u,p()}function O(c){var R;return((R=n().drop_buff)==null?void 0:R[c])||1}function k(){const c=n();if(c.sort||(c.sort={}),c.sort.list){delete c.sort.list,p();return}c.sort.list=!0,p()}function x(){var u;return((u=n().sort)==null?void 0:u.list)||!1}function E(){const c=n();if(c.sort||(c.sort={}),c.sort.score){delete c.sort.score,p();return}c.sort.score=!0,p()}function Q(){var u;return((u=n().sort)==null?void 0:u.score)||!1}function D(c){const u=n();if(u.ignored_rarities||(u.ignored_rarities={}),u.ignored_rarities[c]){delete u.ignored_rarities[c],p();return}u.ignored_rarities[c]=!0,p()}function A(c){var R;return((R=n().ignored_rarities)==null?void 0:R[c])||!1}return{get:r,setChapterRange:a,getChapterRange:f,disableDifficulty:l,getDisabledDifficulties:j,isDisabledDifficulty:N,setItemFilter:m,getItemFilter:y,setDropBuff:H,getDropBuff:O,toggleListSort:k,getListSort:x,toggleScoreSort:E,getScoreSort:Q,ignoreRarity:D,isRarityIgnored:A}})();return{set:s,setAll:M,get:w,hideContent:q,setHideContent:J,isAutoEnableProjects:W,setAutoEnableProjects:o,isInventoryAlternativeMode:C,setInventoryAlternativeMode:e,quest:d}})(),i=(()=>{function s(o){t.user_state.projects=o,p()}function M(){return t.user_state.projects}function w(o){console.log("Add project"),t.user_state.projects[o.date||Date.now()]=o,p()}function q(o,C){t.user_state.projects[o]&&(t.user_state.projects[o]=C,p())}function J(o){delete t.user_state.projects[o],p()}function W(o,C={}){if(!t.user_state.projects[o.date])return;let e=C.consume?T.consume(o,g.get(),h.get().region,o.details.ignored_rarities):g.get();if(C.save&&o.type==="character"){const d=o.details.avatar_id,n=S.get();S.set({...n,[d]:{id:d,rank:o.details.end.rank,equipment:o.details.end.equipment}}),g.set(e),J(o.date);return}g.set(e),J(o.date)}return{set:s,get:M,add:w,replace:q,delete:J,complete:W}})(),P=(()=>{function s(w){t.user_state.settings.region=w,p()}function M(){return t.user_state.settings.region||"UNKNOWN"}return{set:s,get:M}})();return{init:_,get:K,save:p,isInit:L,_toggle_localstorage:b,getSessionProjects:V,getSessionIgnoredRarities:v,inventory:g,character:S,settings:h,projects:i,region:P}})();export{T as p,z as q,G as u};
