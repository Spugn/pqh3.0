var G=Object.defineProperty;var Y=(d,C,H)=>C in d?G(d,C,{enumerable:!0,configurable:!0,writable:!0,value:H}):d[C]=H;var T=(d,C,H)=>(Y(d,typeof C!="symbol"?C+"":C,H),H);import{f as z,g as Z,c as M}from"./tslib.es6-aba24c98.js";import{e as $}from"./equipment.api-3b337066.js";const L=(()=>{function d(b,q,m="UNKNOWN",k={}){const g=JSON.parse(JSON.stringify(q)),i={};for(const s in b.required)P(s,b.required[s]);return i;function P(s,x){const I=$.recipe(s,m),p=$.fragmentID(s);if(g[s]&&!k[$.rarity(s)]){if(i[s]=x-g[s],i[s]<=0){i[s]=x,g[s]-=x;return}i[s]=g[s],x-=g[s],g[s]=0}if(!k[$.rarity(s)]&&I.required_pieces>0&&(i[p]=I.required_pieces*x+(i[p]||0)),!k[$.rarity(s)])for(const J of I.required_items)P(J,x)}}function C(b,q,m="UNKNOWN",k={}){const g=`api.project#check: (${m} | ${b.date})`;console.time(g);const i=d(b,q,m,k),P=JSON.parse(JSON.stringify(i));for(const s in i)i[s]-=q[s]||0,i[s]<=0&&delete i[s];return console.timeEnd(g),{success:Object.keys(i).length<=0,remaining:i,recipe:P}}function H(b,q,m="UNKNOWN",k={}){const g=`api.project#consume: (${m} | ${b.date})`;console.time(g);const i=JSON.parse(JSON.stringify(q)),P=d(b,q,m,k);for(const s in P)i[s]-=P[s],(i[s]<=0||isNaN(i[s]))&&delete i[s];return console.timeEnd(g),i}function _(b){const q={};for(const m of b)for(const k in m.required)q[k]=(q[k]||0)+m.required[k];return q}function F(b,q,m="UNKNOWN",k={}){const g=C(b,q,m,k),i={progress:-1,items:{current:0,max:0},fragments:{current:0,max:0},check:g};for(const P in g.recipe)i.items.max++,i.fragments.max+=g.recipe[P];if(g.success)return i.progress=100,i.items.current=i.items.max,i.fragments.current=i.fragments.max,i;for(const P in g.remaining)i.items.current++,i.fragments.current+=g.remaining[P];return i.items.current=i.items.max-i.items.current,i.fragments.current=i.fragments.max-i.fragments.current,i.progress=parseFloat((i.fragments.current/i.fragments.max*100).toFixed(2)),i}function K(b=0){const q={};if(b>0)for(let P=0;P<b&&Object.keys(q).length<b;P++)q[$.getRandomItem()]=10;const m=z.getRandomCharacter(),k=Math.floor(Math.random()*z.getMaxRank())+1,g=Math.floor(Math.random()*k)+1;return{type:"character",date:Date.now(),priority:!1,details:{avatar_id:m.id,formal_name:`${m.name.JP} (${m.id})`,name:m.name.JP,start:{rank:g,equipment:i()},end:{rank:k,equipment:i()},memory_piece:0,pure_memory_piece:0,ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:q};function i(){return[Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5]}}function V(b=0){const q={};if(b>0)for(let m=0;m<b&&Object.keys(q).length<b;m++)q[$.getRandomItem()]=10;return{type:"item",date:Date.now(),priority:!1,details:{name:"Untitled Project",ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:q}}return{build:d,check:C,consume:H,compile:_,progress:F,getTestCharacterProject:K,getTestItemProject:V}})();class B{}T(B,"max_chapter",-1);const Q=(()=>{const d=Z.quest;function C(e){return d[e]}function H(e,n){var t,a,c,l,y;if(d[e])return n?((c=(a=d[e])==null?void 0:a.name)==null?void 0:c[n])||((y=(l=d[e])==null?void 0:l.name)==null?void 0:y.JP):(t=d[e])==null?void 0:t.name}function _(e,n){var t,a,c,l,y;if(d[e])return n?((c=(a=d[e])==null?void 0:a.stamina)==null?void 0:c[n])||((y=(l=d[e])==null?void 0:l.stamina)==null?void 0:y.JP):(t=d[e])==null?void 0:t.stamina}function F(e,n){var c,l;const t=(c=d[e])==null?void 0:c.drop_table[n],a=t?t.memory_piece:(l=d[e])==null?void 0:l.drop_table.JP.memory_piece;return a&&a.item!==M.placeholder_id?a:void 0}function K(e,n){var c,l;const t=(c=d[e])==null?void 0:c.drop_table[n];return(t?t.drops:(l=d[e])==null?void 0:l.drop_table.JP.drops)||[]}function V(e,n){var c,l;const t=(c=d[e])==null?void 0:c.drop_table[n];return(t?t.subdrops:(l=d[e])==null?void 0:l.drop_table.JP.subdrops)||[]}function b(e){return e!==""&&!e.includes(M.difficulty.hard)&&!e.includes(M.difficulty.event)}function q(e){return e.includes(M.difficulty.hard)&&!e.includes(M.difficulty.very_hard)}function m(e){return e.includes(M.difficulty.very_hard)}function k(e){return e.includes(M.difficulty.event)}function g(e){return parseInt(e.split("-")[0])}function i(e){return parseInt(e.split("-")[1])}function P(){if(B.max_chapter===-1){let e=-1;for(const n in d){const t=g(n);e=Math.max(e,t)}B.max_chapter=e}return B.max_chapter}function s(e){return d[e]!==void 0}function x({all_projects:e,compiled_items:n,inventory:t,settings:a={},use_inventory:c=!1,language:l="UNKNOWN"}){const y=`api.quest#build: (${l} | ${Date.now().toLocaleString()})`;console.time(y);let D,u;if(c){const A=L.check({date:"quest-build",required:n},t,l,a.ignored_rarities);D=A.remaining,u=A.recipe}else D=u=L.build({date:"quest-build",required:n},{},l,a.ignored_rarities);if(Object.keys(D).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(y),{required:D,required_clean:u,quest_scores:[],priority_items:[],priority_amount:{}};let j=new Set,w={};for(const A of e)if(A.priority)for(const v in A.required)$.exists(v)&&(j.add(v),w[v]=(w[v]||0)+A.required[v]);const S=Array.from(j).reduce((A,v)=>(A[v]=w[v],A),{});w=L.build({date:"quest-build",required:S},{},l,{});const N=Object.keys(w),E=p({required:D,priority_items:N,settings:a,language:l});return console.timeEnd(y),{required:D,required_clean:u,quest_scores:E,priority_items:N,priority_amount:w}}function I({session_projects:e,inventory:n,settings:t,use_inventory:a=!1,language:c}){n||(n=X.inventory.get()),t||(t=X.settings.quest.get()),c||(c=X.region.get());const l=`api.quest#build2: (${c} | ${Date.now().toLocaleString()})`;console.time(l);const y=Object.keys(e).filter(v=>e[v].enabled).map(v=>e[v].project),D=L.compile(y);let u,j;if(a){const v=L.check({date:"quest-build-with-inventory",required:D},n,c,t.ignored_rarities);u=v.remaining,j=v.recipe}else u=j=L.build({date:"quest-build-no-inventory",required:D},{},c,t.ignored_rarities);if(Object.keys(u).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(l),{required:u,required_clean:j,quest_scores:[],priority_items:[],priority_amount:{},projects:y};let w=new Set,S={};for(const v in e){const O=e[v].project;if(O.priority)for(const U in O.required)$.exists(U)&&(w.add(U),S[U]=(S[U]||0)+O.required[U])}const N=Array.from(w).reduce((v,O)=>(v[O]=S[O],v),{});S=L.build({date:"quest-build-priority-amount",required:N},{},c,{});const E=Object.keys(S),A=p({required:u,priority_items:E,settings:t,language:c});return console.timeEnd(l),{required:u,required_clean:j,quest_scores:A,priority_items:E,priority_amount:S,projects:y}}function p({required:e,priority_items:n,settings:t={},language:a="UNKNOWN"}){var l,y,D;let c=[];for(const u in d){let j=function(N){if(!N||!e.hasOwnProperty(N.item))return 0;let E=N.drop_rate;return E*=n.includes(N.item)?M.multiplier.priority:1,E+=e[N.item]/M.inventory.max.fragment*1e3,E};const w=g(u);if(t.chapter&&(w<t.chapter.min||w>t.chapter.max)||t.disabled_difficulty&&(t.disabled_difficulty.Normal&&b(u)||t.disabled_difficulty.Hard&&q(u)||t.disabled_difficulty["Very Hard"]&&m(u)||t.disabled_difficulty.Event&&k(u)))continue;if(t.item_filter&&t.item_filter.length>0){let N=!1;for(const E of t.item_filter)if(J(E,u,a)){N=!0;break}if(!N)continue}let S=0;S+=j(F(u,a));for(const N of K(u,a))S+=j(N);for(const N of V(u,a))S+=j(N);if(b(u)&&((l=t==null?void 0:t.drop_buff)!=null&&l.Normal)&&(S*=t.drop_buff.Normal),q(u)&&((y=t==null?void 0:t.drop_buff)!=null&&y.Hard)&&(S*=t.drop_buff.Hard),m(u)&&((D=t==null?void 0:t.drop_buff)!=null&&D["Very Hard"])&&(S*=t.drop_buff["Very Hard"]),S>0){const N=_(u,a);typeof N=="number"&&(S/=N),c.push({id:u,score:+S.toFixed(2)})}}return c.sort((u,j)=>{const w={id:u.id,chapter:g(u.id),number:i(u.id),value:0},S={id:j.id,chapter:g(j.id),number:i(j.id),value:0};function N(O){m(O.id)&&(O.value+=2e3),(q(O.id)||k(O.id))&&(O.value+=1e3),O.value+=O.chapter*1e4+O.number*10}function E(O,U){return O-U}function A(O,U){return U-O}N(w),N(S);let v=t.sort&&t.sort.score?E(u.score,j.score):A(u.score,j.score);return v!==0?v:t.sort&&t.sort.list?A(w.value,S.value):E(w.value,S.value)}),c}function J(e,n,t){let a,c;if($.exists(e)?(a=e,c=$.fragment(e)):(a=$.convertFragmentID(e),c=e),a===M.placeholder_id)return!1;const l=F(n,t);if((l==null?void 0:l.item)===a)return!0;for(const y of K(n,t))if(y.item===a||y.item===c)return!0;for(const y of V(n,t))if(y.item===a||y.item===c)return!0;return!1}function W(e){console.time("quest.estimate");const t=L.build({required:e},{});let a=0;for(const c in d){let l=function(y){const D=F(c,"JP");if(D&&t.hasOwnProperty(D.item))return++y;for(const u of K(c,"JP"))if(t.hasOwnProperty(u.item))return++y;for(const u of V(c,"JP"))if(t.hasOwnProperty(u.item))return++y;return y};if(a>=100)break;a=l(a)}return console.timeEnd("quest.estimate"),a}function o(e,n){return s(e)&&C(e).name[n]!==void 0}return{data:d,get:C,name:H,stamina:_,memoryPiece:F,drops:K,subdrops:V,isNormal:b,isHard:q,isVeryHard:m,isEvent:k,getChapter:g,getNumber:i,getMaxChapter:P,exists:s,build:x,build2:I,search:p,checkForItem:J,estimate:W,existsInRegion:o}})();class r{}T(r,"is_init"),T(r,"user_state"),T(r,"force_no_localstorage"),T(r,"projects",{}),T(r,"create_project_ignored_rarities",{});const X=(()=>{function d(){if(!K()){if(F()){localStorage.getItem(M.legacy_localstorage_key)?(console.log("importing old settings"),C()):localStorage.getItem(M.localstorage_key)===null?(console.log("init new user"),r.user_state=JSON.parse(JSON.stringify(M.default_user_state)),_()):(console.log("loading user from localstorage"),r.user_state=JSON.parse(localStorage.getItem(M.localstorage_key))),r.is_init=!0;return}console.warn("localstorage is not supported on this browser, using basic state"),r.user_state=JSON.parse(JSON.stringify(M.default_user_state)),r.is_init=!0}}function C(){var I;const s=JSON.parse(localStorage.getItem(M.legacy_localstorage_key));r.user_state=JSON.parse(JSON.stringify(M.default_user_state));for(const p in s.character){const J=s.character[p];r.user_state.character[p]={...J,id:p}}r.user_state.inventory=s.inventory;for(const p of s.projects){let J={};p.details.ignored_rarity&&(J=JSON.parse(JSON.stringify(p.details.ignored_rarity)),delete p.details.ignored_rarity),r.user_state.projects[p.date]={type:p.type,date:parseInt(p.date),priority:p.priority,details:{...p.details,ignored_rarities:J,...!p.details.memory_piece&&{memory_piece:0},...!p.details.pure_memory_piece&&{pure_memory_piece:0}},required:p.required}}r.user_state.settings.region=s.settings.region;let x={};s.settings.quest.ignored_rarity&&(x=JSON.parse(JSON.stringify(s.settings.quest.ignored_rarity)),delete s.settings.quest.ignored_rarity),r.user_state.settings.quest=s.settings.quest,r.user_state.settings.quest.ignored_rarities=x,(I=r.user_state.settings.quest.chapter)!=null&&I.max&&Q.getMaxChapter()<s.settings.quest.chapter.max&&(r.user_state.settings.quest.chapter.max=Q.getMaxChapter(),r.user_state.settings.quest.chapter.min&&r.user_state.settings.quest.chapter.min>r.user_state.settings.quest.chapter.max&&(r.user_state.settings.quest.chapter.min=r.user_state.settings.quest.chapter.max)),_(),localStorage.removeItem(M.legacy_localstorage_key)}function H(){return r.user_state||d(),r.user_state}function _(){if(!F()){console.log("local storage not supported, cant save");return}localStorage.setItem(M.localstorage_key,JSON.stringify(r.user_state)),console.log("saved user state",r.user_state)}function F(){return typeof Storage<"u"&&!r.force_no_localstorage}function K(){return r.is_init}function V(){return r.projects}function b(){return r.create_project_ignored_rarities}function q(){r.force_no_localstorage=!r.force_no_localstorage}const m=(()=>{function s(o){r.user_state.inventory=o,_()}function x(o,e){e<=0?delete r.user_state.inventory[o]:r.user_state.inventory[o]=e>=M.inventory.max.fragment?M.inventory.max.fragment:e,_()}function I(){return r.user_state.inventory}function p(o){return r.user_state.inventory[o]||0}function J(o,e){x(o,p(o)+e)}function W(o){delete r.user_state.inventory[o],_()}return{set:s,setAmount:x,get:I,getAmount:p,remove:W,addAmount:J}})(),k=(()=>{function s(o){r.user_state.character=o,_()}function x(){return r.user_state.character}function I(o,e,n){r.user_state.character={...r.user_state.character,[o]:r.user_state.character[o]||{id:o},[o]:{...r.user_state.character[o],rank:e,equipment:n}},_()}function p(o){return r.user_state.character[o]}function J(o){return r.user_state.character[o]!==void 0}function W(o){J(o)&&(delete r.user_state.character[o],_())}return{set:s,get:x,setCharacter:I,getCharacter:p,exists:J,remove:W}})(),g=(()=>{function s(n,t){r.user_state.settings={...r.user_state.settings,[n]:t},_()}function x(n){r.user_state.settings=n,_()}function I(){return r.user_state.settings}function p(){return r.user_state.settings.hide_content||!1}function J(n){s("hide_content",n)}function W(){return r.user_state.settings.auto_enable_projects||!1}function o(n){s("auto_enable_projects",n)}const e=(()=>{function n(){return r.user_state.settings.quest||(r.user_state.settings.quest={}),r.user_state.settings.quest}function t(){return n()}function a(f,h){const R=n();R.chapter={min:f,max:h,auto_max:h===Q.getMaxChapter()},_()}function c(){return n().chapter}function l(f){const h=n();if(h.disabled_difficulty||(h.disabled_difficulty={}),h.disabled_difficulty[f]){delete h.disabled_difficulty[f],_();return}h.disabled_difficulty[f]=!0,_()}function y(){return n().disabled_difficulty}function D(f){var h;return((h=y())==null?void 0:h[f])||!1}function u(f){const h=n();h.item_filter=f,_()}function j(){return n().item_filter||[]}function w(f,h){const R=n();if(R.drop_buff||(R.drop_buff={}),h===1){delete R.drop_buff[f],_();return}R.drop_buff[f]=h,_()}function S(f){var R;return((R=n().drop_buff)==null?void 0:R[f])||1}function N(){const f=n();if(f.sort||(f.sort={}),f.sort.list){delete f.sort.list,_();return}f.sort.list=!0,_()}function E(){var h;return((h=n().sort)==null?void 0:h.list)||!1}function A(){const f=n();if(f.sort||(f.sort={}),f.sort.score){delete f.sort.score,_();return}f.sort.score=!0,_()}function v(){var h;return((h=n().sort)==null?void 0:h.score)||!1}function O(f){const h=n();if(h.ignored_rarities||(h.ignored_rarities={}),h.ignored_rarities[f]){delete h.ignored_rarities[f],_();return}h.ignored_rarities[f]=!0,_()}function U(f){var R;return((R=n().ignored_rarities)==null?void 0:R[f])||!1}return{get:t,setChapterRange:a,getChapterRange:c,disableDifficulty:l,getDisabledDifficulties:y,isDisabledDifficulty:D,setItemFilter:u,getItemFilter:j,setDropBuff:w,getDropBuff:S,toggleListSort:N,getListSort:E,toggleScoreSort:A,getScoreSort:v,ignoreRarity:O,isRarityIgnored:U}})();return{set:s,setAll:x,get:I,hideContent:p,setHideContent:J,isAutoEnableProjects:W,setAutoEnableProjects:o,quest:e}})(),i=(()=>{function s(o){r.user_state.projects=o,_()}function x(){return r.user_state.projects}function I(o){console.log("Add project"),r.user_state.projects[o.date||Date.now()]=o,_()}function p(o,e){r.user_state.projects[o]&&(r.user_state.projects[o]=e,_())}function J(o){delete r.user_state.projects[o],_()}function W(o,e={}){if(!r.user_state.projects[o.date])return;let n=e.consume?L.consume(o,m.get(),g.get().region,o.details.ignored_rarities):m.get();if(e.save&&o.type==="character"){const t=o.details.avatar_id,a=k.get();k.set({...a,[t]:{id:t,rank:o.details.end.rank,equipment:o.details.end.equipment}}),m.set(n),J(o.date);return}m.set(n),J(o.date)}return{set:s,get:x,add:I,replace:p,delete:J,complete:W}})(),P=(()=>{function s(I){r.user_state.settings.region=I,_()}function x(){return r.user_state.settings.region||"UNKNOWN"}return{set:s,get:x}})();return{init:d,get:H,save:_,isInit:K,_toggle_localstorage:q,getSessionProjects:V,getSessionIgnoredRarities:b,inventory:m,character:k,settings:g,projects:i,region:P}})();export{L as p,Q as q,X as u};
