var oe=Object.defineProperty;var ie=(h,K,W)=>K in h?oe(h,K,{enumerable:!0,configurable:!0,writable:!0,value:W}):h[K]=W;var Y=(h,K,W)=>(ie(h,typeof K!="symbol"?K+"":K,W),W);import{f as ne,g as ae,c as w}from"./tslib.es6-f283e7f1.js";import{e as R}from"./equipment.api-8e7ce804.js";const G=(()=>{function h(O,k,b="UNKNOWN",P={}){const v=JSON.parse(JSON.stringify(k)),u={};for(const s in O.required)E(s,O.required[s]);return u;function E(s,M){const C=R.recipe(s,b),j=R.fragmentID(s);if(v[s]&&!P[R.rarity(s)]){if(u[s]=M-v[s],u[s]<=0){u[s]=M,v[s]-=M;return}u[s]=v[s],M-=v[s],v[s]=0}if(!P[R.rarity(s)]&&C.required_pieces>0&&(u[j]=C.required_pieces*M+(u[j]||0)),!P[R.rarity(s)])for(const D of C.required_items)E(D,M)}}function K(O,k,b="UNKNOWN",P={},v=!1){const u=`api.project#check: (${b} | ${O.date})`;v||console.time(u);const E=h(O,k,b,P),s=JSON.parse(JSON.stringify(E));for(const M in E)E[M]-=k[M]||0,E[M]<=0&&delete E[M];return v||console.timeEnd(u),{success:Object.keys(E).length<=0,remaining:E,recipe:s}}function W(O,k,b="UNKNOWN",P={}){const v=`api.project#consume: (${b} | ${O.date})`;console.time(v);const u=JSON.parse(JSON.stringify(k)),E=h(O,k,b,P);for(const s in E)u[s]-=E[s],(u[s]<=0||isNaN(u[s]))&&delete u[s];return console.timeEnd(v),u}function y(O){const k={};for(const b of O)for(const P in b.required)k[P]=(k[P]||0)+b.required[P];return k}function L(O,k,b="UNKNOWN",P={}){const v=K(O,k,b,P),u={progress:-1,items:{current:0,max:0},fragments:{current:0,max:0},check:v};for(const E in v.recipe)u.items.max++,u.fragments.max+=v.recipe[E];if(v.success)return u.progress=100,u.items.current=u.items.max,u.fragments.current=u.fragments.max,u;for(const E in v.remaining)u.items.current++,u.fragments.current+=v.remaining[E];return u.items.current=u.items.max-u.items.current,u.fragments.current=u.fragments.max-u.fragments.current,u.progress=parseFloat((u.fragments.current/u.fragments.max*100).toFixed(2)),u}function Q(O=0){const k={};if(O>0)for(let E=0;E<O&&Object.keys(k).length<O;E++)k[R.getRandomItem()]=10;const b=ne.getRandomCharacter(),P=Math.floor(Math.random()*ne.getMaxRank())+1,v=Math.floor(Math.random()*P)+1;return{type:"character",date:Date.now(),priority:!1,details:{avatar_id:b.id,formal_name:`${b.name.JP} (${b.id})`,name:b.name.JP,start:{rank:v,equipment:u()},end:{rank:P,equipment:u()},memory_piece:0,pure_memory_piece:0,ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:k};function u(){return[Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5]}}function X(O=0){const k={};if(O>0)for(let b=0;b<O&&Object.keys(k).length<O;b++)k[R.getRandomItem()]=10;return{type:"item",date:Date.now(),priority:!1,details:{name:"Untitled Project",ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:k}}return{build:h,check:K,consume:W,compile:y,progress:L,getTestCharacterProject:Q,getTestItemProject:X}})();class te{}Y(te,"max_chapter",-1);const re=(()=>{const h=ae.quest;function K(t){return h[t]}function W(t,f){var d,r,n,a,_;if(h[t])return f?((n=(r=h[t])==null?void 0:r.name)==null?void 0:n[f])||((_=(a=h[t])==null?void 0:a.name)==null?void 0:_.JP):(d=h[t])==null?void 0:d.name}function y(t,f){var d,r,n,a,_;if(h[t])return f?((n=(r=h[t])==null?void 0:r.stamina)==null?void 0:n[f])||((_=(a=h[t])==null?void 0:a.stamina)==null?void 0:_.JP):(d=h[t])==null?void 0:d.stamina}function L(t,f){var n,a;const d=(n=h[t])==null?void 0:n.drop_table[f],r=d?d.memory_piece:(a=h[t])==null?void 0:a.drop_table.JP.memory_piece;return r&&r.item!==w.placeholder_id?r:void 0}function Q(t,f){var n,a;const d=(n=h[t])==null?void 0:n.drop_table[f];return(d?d.drops:(a=h[t])==null?void 0:a.drop_table.JP.drops)||[]}function X(t,f){var n,a;const d=(n=h[t])==null?void 0:n.drop_table[f];return(d?d.subdrops:(a=h[t])==null?void 0:a.drop_table.JP.subdrops)||[]}function O(t){return t!==""&&!t.includes(w.difficulty.hard)&&!t.includes(w.difficulty.event)}function k(t){return t.includes(w.difficulty.hard)&&!t.includes(w.difficulty.very_hard)}function b(t){return t.includes(w.difficulty.very_hard)}function P(t){return t.includes(w.difficulty.event)}function v(t){return parseInt(t.split("-")[0])}function u(t){return parseInt(t.split("-")[1])}function E(){if(te.max_chapter===-1){let t=-1;for(const f in h){const d=v(f);t=Math.max(t,d)}te.max_chapter=t}return te.max_chapter}function s(t){return h[t]!==void 0}function M({all_projects:t,compiled_items:f,inventory:d,settings:r={},use_inventory:n=!1,language:a="UNKNOWN"}){const _=`api.quest#build: (${a} | ${Date.now().toLocaleString()})`;console.time(_);let o,p;if(n){const I=G.check({date:"quest-build",required:f},d,a,r.ignored_rarities);o=I.remaining,p=I.recipe}else o=p=G.build({date:"quest-build",required:f},{},a,r.ignored_rarities);if(Object.keys(o).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(_),{required:o,required_clean:p,quest_scores:[],priority_items:[],priority_amount:{}};let l=new Set,q={};for(const I of t)if(I.priority)for(const J in I.required)R.exists(J)&&(l.add(J),q[J]=(q[J]||0)+I.required[J]);const S=Array.from(l).reduce((I,J)=>(I[J]=q[J],I),{});q=G.build({date:"quest-build",required:S},{},a,{});const x=Object.keys(q),c=D({required:o,priority_items:x,priority_levels:{},settings:r,language:a});return console.timeEnd(_),{required:o,required_clean:p,quest_scores:c,priority_items:x,priority_amount:q}}function C({session_projects:t,inventory:f,settings:d,use_inventory:r=!1,language:n,silent:a=!1}){var F;f||(f=ee.inventory.get()),d||(d=ee.settings.quest.get()),n||(n=ee.region.get());const _=`api.quest#build2: (${n} | ${Date.now().toLocaleString()})`;a||console.time(_);const o=Object.keys(t).filter(m=>t[m].enabled).map(m=>t[m].project),p=G.compile(o);let l,q;if(r){const m=G.check({date:"quest-build-with-inventory",required:p},f,n,d.ignored_rarities,a);l=m.remaining,q=m.recipe}else l=q=G.build({date:"quest-build-no-inventory",required:p},{},n,d.ignored_rarities);if(Object.keys(l).length<=0)return a||(console.log("can't make quest list with no required items"),console.timeEnd(_)),{required:l,required_clean:q,quest_scores:[],priority_items:[],priority_amount:{},projects:o};let S={},x=new Set,c={};for(const m in t){const B=t[m].project;if(B.priority)for(const V in B.required){if(!R.exists(V))continue;const Z=((F=B.details)==null?void 0:F.priority_level)||2;S[V]=S[V]&&S[V]>Z?S[V]:Z,x.add(V),c[V]=(c[V]||0)+B.required[V]}}const I=Array.from(x).reduce((m,B)=>(m[B]=c[B],m),{}),J=j(I,S,n),A=Object.keys(J.priority_amount),H=D({required:l,priority_items:A,priority_levels:J.priority_levels,settings:d,language:n});return a||console.timeEnd(_),{required:l,required_clean:q,quest_scores:H,priority_items:A,priority_amount:c,projects:o}}function j(t,f,d="UNKNOWN"){const r={},n={};for(const _ in t)a(_,t[_],f[_]);return{priority_amount:r,priority_levels:n};function a(_,o,p){const l=R.recipe(_,d),q=R.fragmentID(_);l.required_pieces>0&&(r[q]=l.required_pieces*o+(r[q]||0),n[q]=n[q]&&n[q]>p?n[q]:p);for(const S of l.required_items)a(S,o,p)}}function D({required:t,priority_items:f,priority_levels:d,settings:r={},language:n="UNKNOWN"}){var _,o,p;let a=[];for(const l in h){let q=function(c){if(!c||!t.hasOwnProperty(c.item))return 0;let I=c.drop_rate;return I*=f.includes(c.item)?d[c.item]:1,I+=t[c.item]/w.inventory.max.fragment*1e3,I};const S=v(l);if(r.chapter&&(S<r.chapter.min||S>r.chapter.max)||r.disabled_difficulty&&(r.disabled_difficulty.Normal&&O(l)||r.disabled_difficulty.Hard&&k(l)||r.disabled_difficulty["Very Hard"]&&b(l)||r.disabled_difficulty.Event&&P(l)))continue;if(r.item_filter&&r.item_filter.length>0){let c=!1;for(const I of r.item_filter)if(T(I,l,n)){c=!0;break}if(!c)continue}let x=0;x+=q(L(l,n));for(const c of Q(l,n))x+=q(c);for(const c of X(l,n))x+=q(c);if(O(l)&&((_=r==null?void 0:r.drop_buff)!=null&&_.Normal)&&(x*=r.drop_buff.Normal),k(l)&&((o=r==null?void 0:r.drop_buff)!=null&&o.Hard)&&(x*=r.drop_buff.Hard),b(l)&&((p=r==null?void 0:r.drop_buff)!=null&&p["Very Hard"])&&(x*=r.drop_buff["Very Hard"]),x>0){const c=y(l,n);typeof c=="number"&&(x/=c),a.push({id:l,score:+x.toFixed(2)})}}return a.sort((l,q)=>{const S={id:l.id,chapter:v(l.id),number:u(l.id),value:0},x={id:q.id,chapter:v(q.id),number:u(q.id),value:0};function c(H){b(H.id)&&(H.value+=2e3),(k(H.id)||P(H.id))&&(H.value+=1e3),H.value+=H.chapter*1e4+H.number*10}function I(H,F){return H-F}function J(H,F){return F-H}c(S),c(x);let A=r.sort&&r.sort.score?I(l.score,q.score):J(l.score,q.score);return A!==0?A:r.sort&&r.sort.list?J(S.value,x.value):I(S.value,x.value)}),a}function T(t,f,d){let r,n;if(R.exists(t)?(r=t,n=R.fragment(t)):(r=R.convertFragmentID(t),n=t),r===w.placeholder_id)return!1;const a=L(f,d);if((a==null?void 0:a.item)===r)return!0;for(const _ of Q(f,d))if(_.item===r||_.item===n)return!0;for(const _ of X(f,d))if(_.item===r||_.item===n)return!0;return!1}function i(t){console.time("quest.estimate");const d=G.build({required:t},{});let r=0;for(const n in h){let a=function(_){const o=L(n,"JP");if(o&&d.hasOwnProperty(o.item))return++_;for(const p of Q(n,"JP"))if(d.hasOwnProperty(p.item))return++_;for(const p of X(n,"JP"))if(d.hasOwnProperty(p.item))return++_;return _};if(r>=100)break;r=a(r)}return console.timeEnd("quest.estimate"),r}function $(t,f={normal_drop:1,hard_drop:1,very_hard_drop:1,use_inventory:!0},d=void 0){const r=`api.quest#questSimulator: (${Date.now().toLocaleString()})`;console.time(r);let n;f.use_inventory?n=JSON.parse(JSON.stringify(ee.inventory.get())):n={};let a;d?a=JSON.parse(JSON.stringify(d)):a=C({session_projects:t,inventory:n,use_inventory:!0,silent:!0,settings:{drop_buff:{Normal:f.normal_drop,Hard:f.hard_drop,"Very Hard":f.very_hard_drop},sort:{list:!0}}});let _=[],o=0,p={};const l=JSON.parse(JSON.stringify(a.required));for(;a.quest_scores.length>0;)q(a.quest_scores[0].id,ee.region.get()),a=C({session_projects:t,inventory:n,use_inventory:!0,silent:!0,settings:{drop_buff:{Normal:f.normal_drop,Hard:f.hard_drop,"Very Hard":f.very_hard_drop},sort:{list:!0}}});return console.timeEnd(r),{stamina:o,quests:_,total_drops:p,required:l};function q(S,x){const c=P(S)?1:b(S)?f.very_hard_drop||1:k(S)?f.hard_drop||1:O(S)&&f.normal_drop||1,I=y(S,x),J={};o+=I;const A=L(S,x);A&&Math.random()*100<=A.drop_rate&&(n[A.item]=n[A.item]?n[A.item]+c:c,p[A.item]=p[A.item]?p[A.item]+c:c,J[A.item]=J[A.item]?J[A.item]+c:c);for(const m of Q(S,x)){if(m.item===w.placeholder_id)continue;Math.random()*100<=m.drop_rate&&(n[m.item]=n[m.item]?n[m.item]+c:c,p[m.item]=p[m.item]?p[m.item]+c:c,J[m.item]=J[m.item]?J[m.item]+c:c)}const H=Math.random()*100;let F=0;for(const m of X(S,x))if(m.item!==w.placeholder_id&&(F+=m.drop_rate,H<=F)){n[m.item]=n[m.item]?n[m.item]+c:c,p[m.item]=p[m.item]?p[m.item]+c:c,J[m.item]=J[m.item]?J[m.item]+c:c;break}_.push({id:S,stamina:I,total_stamina:o,drops:J})}}function z(t,f){return s(t)&&K(t).name[f]!==void 0}return{data:h,get:K,name:W,stamina:y,memoryPiece:L,drops:Q,subdrops:X,isNormal:O,isHard:k,isVeryHard:b,isEvent:P,getChapter:v,getNumber:u,getMaxChapter:E,exists:s,build:M,build2:C,search:D,checkForItem:T,estimate:i,existsInRegion:z,questSimulator:$}})();class e{}Y(e,"is_init"),Y(e,"user_state"),Y(e,"force_no_localstorage"),Y(e,"projects",{}),Y(e,"create_project_ignored_rarities",{});const ee=(()=>{function h(){if(!Q()){if(L()){localStorage.getItem(w.legacy_localstorage_key)?(console.log("importing old settings"),K()):localStorage.getItem(w.localstorage_key)===null?(console.log("init new user"),e.user_state=JSON.parse(JSON.stringify(w.default_user_state)),y()):(console.log("loading user from localstorage"),e.user_state=JSON.parse(localStorage.getItem(w.localstorage_key))),e.is_init=!0;return}console.warn("localstorage is not supported on this browser, using basic state"),e.user_state=JSON.parse(JSON.stringify(w.default_user_state)),e.is_init=!0}}function K(){var C;const s=JSON.parse(localStorage.getItem(w.legacy_localstorage_key));e.user_state=JSON.parse(JSON.stringify(w.default_user_state));for(const j in s.character){const D=s.character[j];e.user_state.character[j]={...D,id:j}}e.user_state.inventory=s.inventory;for(const j of s.projects){let D={};j.details.ignored_rarity&&(D=JSON.parse(JSON.stringify(j.details.ignored_rarity)),delete j.details.ignored_rarity),e.user_state.projects[j.date]={type:j.type,date:parseInt(j.date),priority:j.priority,details:{...j.details,ignored_rarities:D,...!j.details.memory_piece&&{memory_piece:0},...!j.details.pure_memory_piece&&{pure_memory_piece:0}},required:j.required}}e.user_state.settings.region=s.settings.region;let M={};s.settings.quest.ignored_rarity&&(M=JSON.parse(JSON.stringify(s.settings.quest.ignored_rarity)),delete s.settings.quest.ignored_rarity),e.user_state.settings.quest=s.settings.quest,e.user_state.settings.quest.ignored_rarities=M,(C=e.user_state.settings.quest.chapter)!=null&&C.max&&re.getMaxChapter()<s.settings.quest.chapter.max&&(e.user_state.settings.quest.chapter.max=re.getMaxChapter(),e.user_state.settings.quest.chapter.min&&e.user_state.settings.quest.chapter.min>e.user_state.settings.quest.chapter.max&&(e.user_state.settings.quest.chapter.min=e.user_state.settings.quest.chapter.max)),y(),localStorage.removeItem(w.legacy_localstorage_key)}function W(){return e.user_state||h(),e.user_state}function y(){if(!L()){console.log("local storage not supported, cant save");return}localStorage.setItem(w.localstorage_key,JSON.stringify(e.user_state)),console.log("saved user state",e.user_state)}function L(){return typeof Storage<"u"&&!e.force_no_localstorage}function Q(){return e.is_init}function X(){return e.projects}function O(){return e.create_project_ignored_rarities}function k(){e.force_no_localstorage=!e.force_no_localstorage}const b=(()=>{function s(i){e.user_state.inventory=i,y()}function M(i,$){$<=0?delete e.user_state.inventory[i]:e.user_state.inventory[i]=$>=w.inventory.max.fragment?w.inventory.max.fragment:$,y()}function C(){return e.user_state.inventory}function j(i){return e.user_state.inventory[i]||0}function D(i,$){M(i,j(i)+$)}function T(i){delete e.user_state.inventory[i],y()}return{set:s,setAmount:M,get:C,getAmount:j,remove:T,addAmount:D}})(),P=(()=>{function s(i){e.user_state.character=i,y()}function M(){return e.user_state.character}function C(i,$,z){e.user_state.character={...e.user_state.character,[i]:e.user_state.character[i]||{id:i},[i]:{...e.user_state.character[i],rank:$,equipment:z}},y()}function j(i){return e.user_state.character[i]}function D(i){return e.user_state.character[i]!==void 0}function T(i){D(i)&&(delete e.user_state.character[i],y())}return{set:s,get:M,setCharacter:C,getCharacter:j,exists:D,remove:T}})(),v=(()=>{function s(o,p){e.user_state.settings={...e.user_state.settings,[o]:p},y()}function M(o){e.user_state.settings=o,y()}function C(){return e.user_state.settings}function j(){return e.user_state.settings.hide_content||!1}function D(o){s("hide_content",o)}function T(){return e.user_state.settings.compact_project_cards||!1}function i(o){s("compact_project_cards",o)}function $(){return e.user_state.settings.auto_enable_projects||!1}function z(o){s("auto_enable_projects",o)}function t(){return e.user_state.settings.keep_enabled_projects!==void 0&&e.user_state.settings.keep_enabled_projects.enabled}function f(o){if(!e.user_state.settings.keep_enabled_projects||o){let p={};for(const l in e.projects)e.projects[l].enabled&&(p[`${e.projects[l].project.date}`]=!0);s("keep_enabled_projects",{enabled:!0,projects:p});return}delete e.user_state.settings.keep_enabled_projects,y()}function d(o){e.user_state.settings.keep_enabled_projects&&(e.user_state.settings.keep_enabled_projects.projects=o,y())}function r(){return e.user_state.settings.keep_enabled_projects?e.user_state.settings.keep_enabled_projects.projects:{}}function n(){return e.user_state.settings.inventory_alternative_mode||!1}function a(o){s("inventory_alternative_mode",o)}const _=(()=>{function o(){return e.user_state.settings.quest||(e.user_state.settings.quest={}),e.user_state.settings.quest}function p(){return o()}function l(g,N){const U=o();U.chapter={min:g,max:N,auto_max:N===re.getMaxChapter()},y()}function q(){return o().chapter}function S(g){const N=o();if(N.disabled_difficulty||(N.disabled_difficulty={}),N.disabled_difficulty[g]){delete N.disabled_difficulty[g],y();return}N.disabled_difficulty[g]=!0,y()}function x(){return o().disabled_difficulty}function c(g){var N;return((N=x())==null?void 0:N[g])||!1}function I(g){const N=o();N.item_filter=g,y()}function J(){return o().item_filter||[]}function A(g,N){const U=o();if(U.drop_buff||(U.drop_buff={}),N===1){delete U.drop_buff[g],y();return}U.drop_buff[g]=N,y()}function H(g){var U;return((U=o().drop_buff)==null?void 0:U[g])||1}function F(){const g=o();if(g.sort||(g.sort={}),g.sort.list){delete g.sort.list,y();return}g.sort.list=!0,y()}function m(){var N;return((N=o().sort)==null?void 0:N.list)||!1}function B(){const g=o();if(g.sort||(g.sort={}),g.sort.score){delete g.sort.score,y();return}g.sort.score=!0,y()}function V(){var N;return((N=o().sort)==null?void 0:N.score)||!1}function Z(g){const N=o();if(N.ignored_rarities||(N.ignored_rarities={}),N.ignored_rarities[g]){delete N.ignored_rarities[g],y();return}N.ignored_rarities[g]=!0,y()}function se(g){var U;return((U=o().ignored_rarities)==null?void 0:U[g])||!1}return{get:p,setChapterRange:l,getChapterRange:q,disableDifficulty:S,getDisabledDifficulties:x,isDisabledDifficulty:c,setItemFilter:I,getItemFilter:J,setDropBuff:A,getDropBuff:H,toggleListSort:F,getListSort:m,toggleScoreSort:B,getScoreSort:V,ignoreRarity:Z,isRarityIgnored:se}})();return{set:s,setAll:M,get:C,hideContent:j,setHideContent:D,isCompactProjectCards:T,setCompactProjectCards:i,isAutoEnableProjects:$,setAutoEnableProjects:z,isInventoryAlternativeMode:n,setInventoryAlternativeMode:a,isKeepEnabledProjects:t,setKeepEnabledProjectsEnabledState:f,setKeepEnabledProjectsEnabledProjects:d,getKeepEnabledProjectsEnabledProjects:r,quest:_}})(),u=(()=>{function s(i){e.user_state.projects=i,y()}function M(){return e.user_state.projects}function C(i){e.user_state.projects[i.date||Date.now()]=i,y()}function j(i,$){e.user_state.projects[i]&&(e.user_state.projects[i]=$,y())}function D(i){delete e.user_state.projects[i],y()}function T(i,$={}){if(!e.user_state.projects[i.date])return;let z=$.consume?G.consume(i,b.get(),v.get().region,i.details.ignored_rarities):b.get();if($.save&&i.type==="character"){const t=i.details.avatar_id,f=P.get();P.set({...f,[t]:{id:t,rank:i.details.end.rank,equipment:i.details.end.equipment}}),b.set(z),D(i.date);return}b.set(z),D(i.date)}return{set:s,get:M,add:C,replace:j,delete:D,complete:T}})(),E=(()=>{function s(C){e.user_state.settings.region=C,y()}function M(){return e.user_state.settings.region||"UNKNOWN"}return{set:s,get:M}})();return{init:h,get:W,save:y,isInit:Q,_toggle_localstorage:k,getSessionProjects:X,getSessionIgnoredRarities:O,inventory:b,character:P,settings:v,projects:u,region:E}})();export{G as p,re as q,ee as u};
