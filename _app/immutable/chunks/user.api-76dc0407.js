var Z=Object.defineProperty;var ee=(_,E,H)=>E in _?Z(_,E,{enumerable:!0,configurable:!0,writable:!0,value:H}):_[E]=H;var T=(_,E,H)=>(ee(_,typeof E!="symbol"?E+"":E,H),H);import{f as Y,g as te,c as I}from"./tslib.es6-74f82098.js";import{e as $}from"./equipment.api-0e86ba89.js";const V=(()=>{function _(v,b,g="UNKNOWN",S={}){const h=JSON.parse(JSON.stringify(b)),i={};for(const n in v.required)w(n,v.required[n]);return i;function w(n,M){const D=$.recipe(n,g),q=$.fragmentID(n);if(h[n]&&!S[$.rarity(n)]){if(i[n]=M-h[n],i[n]<=0){i[n]=M,h[n]-=M;return}i[n]=h[n],M-=h[n],h[n]=0}if(!S[$.rarity(n)]&&D.required_pieces>0&&(i[q]=D.required_pieces*M+(i[q]||0)),!S[$.rarity(n)])for(const J of D.required_items)w(J,M)}}function E(v,b,g="UNKNOWN",S={}){const h=`api.project#check: (${g} | ${v.date})`;console.time(h);const i=_(v,b,g,S),w=JSON.parse(JSON.stringify(i));for(const n in i)i[n]-=b[n]||0,i[n]<=0&&delete i[n];return console.timeEnd(h),{success:Object.keys(i).length<=0,remaining:i,recipe:w}}function H(v,b,g="UNKNOWN",S={}){const h=`api.project#consume: (${g} | ${v.date})`;console.time(h);const i=JSON.parse(JSON.stringify(b)),w=_(v,b,g,S);for(const n in w)i[n]-=w[n],(i[n]<=0||isNaN(i[n]))&&delete i[n];return console.timeEnd(h),i}function p(v){const b={};for(const g of v)for(const S in g.required)b[S]=(b[S]||0)+g.required[S];return b}function K(v,b,g="UNKNOWN",S={}){const h=E(v,b,g,S),i={progress:-1,items:{current:0,max:0},fragments:{current:0,max:0},check:h};for(const w in h.recipe)i.items.max++,i.fragments.max+=h.recipe[w];if(h.success)return i.progress=100,i.items.current=i.items.max,i.fragments.current=i.fragments.max,i;for(const w in h.remaining)i.items.current++,i.fragments.current+=h.remaining[w];return i.items.current=i.items.max-i.items.current,i.fragments.current=i.fragments.max-i.fragments.current,i.progress=parseFloat((i.fragments.current/i.fragments.max*100).toFixed(2)),i}function W(v=0){const b={};if(v>0)for(let w=0;w<v&&Object.keys(b).length<v;w++)b[$.getRandomItem()]=10;const g=Y.getRandomCharacter(),S=Math.floor(Math.random()*Y.getMaxRank())+1,h=Math.floor(Math.random()*S)+1;return{type:"character",date:Date.now(),priority:!1,details:{avatar_id:g.id,formal_name:`${g.name.JP} (${g.id})`,name:g.name.JP,start:{rank:h,equipment:i()},end:{rank:S,equipment:i()},memory_piece:0,pure_memory_piece:0,ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:b};function i(){return[Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.5]}}function L(v=0){const b={};if(v>0)for(let g=0;g<v&&Object.keys(b).length<v;g++)b[$.getRandomItem()]=10;return{type:"item",date:Date.now(),priority:!1,details:{name:"Untitled Project",ignored_rarities:{1:Math.random()<.5,2:Math.random()<.5,3:Math.random()<.5,4:Math.random()<.5,5:Math.random()<.5,6:Math.random()<.5,7:Math.random()<.5,8:Math.random()<.5}},required:b}}return{build:_,check:E,consume:H,compile:p,progress:K,getTestCharacterProject:W,getTestItemProject:L}})();class Q{}T(Q,"max_chapter",-1);const z=(()=>{const _=te.quest;function E(e){return _[e]}function H(e,d){var u,r,a,f,l;if(_[e])return d?((a=(r=_[e])==null?void 0:r.name)==null?void 0:a[d])||((l=(f=_[e])==null?void 0:f.name)==null?void 0:l.JP):(u=_[e])==null?void 0:u.name}function p(e,d){var u,r,a,f,l;if(_[e])return d?((a=(r=_[e])==null?void 0:r.stamina)==null?void 0:a[d])||((l=(f=_[e])==null?void 0:f.stamina)==null?void 0:l.JP):(u=_[e])==null?void 0:u.stamina}function K(e,d){var a,f;const u=(a=_[e])==null?void 0:a.drop_table[d],r=u?u.memory_piece:(f=_[e])==null?void 0:f.drop_table.JP.memory_piece;return r&&r.item!==I.placeholder_id?r:void 0}function W(e,d){var a,f;const u=(a=_[e])==null?void 0:a.drop_table[d];return(u?u.drops:(f=_[e])==null?void 0:f.drop_table.JP.drops)||[]}function L(e,d){var a,f;const u=(a=_[e])==null?void 0:a.drop_table[d];return(u?u.subdrops:(f=_[e])==null?void 0:f.drop_table.JP.subdrops)||[]}function v(e){return e!==""&&!e.includes(I.difficulty.hard)&&!e.includes(I.difficulty.event)}function b(e){return e.includes(I.difficulty.hard)&&!e.includes(I.difficulty.very_hard)}function g(e){return e.includes(I.difficulty.very_hard)}function S(e){return e.includes(I.difficulty.event)}function h(e){return parseInt(e.split("-")[0])}function i(e){return parseInt(e.split("-")[1])}function w(){if(Q.max_chapter===-1){let e=-1;for(const d in _){const u=h(d);e=Math.max(e,u)}Q.max_chapter=e}return Q.max_chapter}function n(e){return _[e]!==void 0}function M({all_projects:e,compiled_items:d,inventory:u,settings:r={},use_inventory:a=!1,language:f="UNKNOWN"}){const l=`api.quest#build: (${f} | ${Date.now().toLocaleString()})`;console.time(l);let j,N;if(a){const x=V.check({date:"quest-build",required:d},u,f,r.ignored_rarities);j=x.remaining,N=x.recipe}else j=N=V.build({date:"quest-build",required:d},{},f,r.ignored_rarities);if(Object.keys(j).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(l),{required:j,required_clean:N,quest_scores:[],priority_items:[],priority_amount:{}};let m=new Set,y={};for(const x of e)if(x.priority)for(const C in x.required)$.exists(C)&&(m.add(C),y[C]=(y[C]||0)+x.required[C]);const R=Array.from(m).reduce((x,C)=>(x[C]=y[C],x),{});y=V.build({date:"quest-build",required:R},{},f,{});const O=Object.keys(y),k=J({required:j,priority_items:O,priority_levels:{},settings:r,language:f});return console.timeEnd(l),{required:j,required_clean:N,quest_scores:k,priority_items:O,priority_amount:y}}function D({session_projects:e,inventory:d,settings:u,use_inventory:r=!1,language:a}){var s;d||(d=G.inventory.get()),u||(u=G.settings.quest.get()),a||(a=G.region.get());const f=`api.quest#build2: (${a} | ${Date.now().toLocaleString()})`;console.time(f);const l=Object.keys(e).filter(c=>e[c].enabled).map(c=>e[c].project),j=V.compile(l);let N,m;if(r){const c=V.check({date:"quest-build-with-inventory",required:j},d,a,u.ignored_rarities);N=c.remaining,m=c.recipe}else N=m=V.build({date:"quest-build-no-inventory",required:j},{},a,u.ignored_rarities);if(Object.keys(N).length<=0)return console.log("can't make quest list with no required items"),console.timeEnd(f),{required:N,required_clean:m,quest_scores:[],priority_items:[],priority_amount:{},projects:l};let y={},R=new Set,O={};for(const c in e){const P=e[c].project;if(P.priority)for(const F in P.required){if(!$.exists(F))continue;const X=((s=P.details)==null?void 0:s.priority_level)||2;y[F]=y[F]&&y[F]>X?y[F]:X,R.add(F),O[F]=(O[F]||0)+P.required[F]}}const k=Array.from(R).reduce((c,P)=>(c[P]=O[P],c),{}),x=q(k,y,a),C=Object.keys(x.priority_amount),B=J({required:N,priority_items:C,priority_levels:x.priority_levels,settings:u,language:a});return console.timeEnd(f),{required:N,required_clean:m,quest_scores:B,priority_items:C,priority_amount:O,projects:l}}function q(e,d,u="UNKNOWN"){const r={},a={};for(const l in e)f(l,e[l],d[l]);return{priority_amount:r,priority_levels:a};function f(l,j,N){const m=$.recipe(l,u),y=$.fragmentID(l);m.required_pieces>0&&(r[y]=m.required_pieces*j+(r[y]||0),a[y]=a[y]&&a[y]>N?a[y]:N);for(const R of m.required_items)f(R,j,N)}}function J({required:e,priority_items:d,priority_levels:u,settings:r={},language:a="UNKNOWN"}){var l,j,N;let f=[];for(const m in _){let y=function(k){if(!k||!e.hasOwnProperty(k.item))return 0;let x=k.drop_rate;return x*=d.includes(k.item)?u[k.item]:1,x+=e[k.item]/I.inventory.max.fragment*1e3,x};const R=h(m);if(r.chapter&&(R<r.chapter.min||R>r.chapter.max)||r.disabled_difficulty&&(r.disabled_difficulty.Normal&&v(m)||r.disabled_difficulty.Hard&&b(m)||r.disabled_difficulty["Very Hard"]&&g(m)||r.disabled_difficulty.Event&&S(m)))continue;if(r.item_filter&&r.item_filter.length>0){let k=!1;for(const x of r.item_filter)if(U(x,m,a)){k=!0;break}if(!k)continue}let O=0;O+=y(K(m,a));for(const k of W(m,a))O+=y(k);for(const k of L(m,a))O+=y(k);if(v(m)&&((l=r==null?void 0:r.drop_buff)!=null&&l.Normal)&&(O*=r.drop_buff.Normal),b(m)&&((j=r==null?void 0:r.drop_buff)!=null&&j.Hard)&&(O*=r.drop_buff.Hard),g(m)&&((N=r==null?void 0:r.drop_buff)!=null&&N["Very Hard"])&&(O*=r.drop_buff["Very Hard"]),O>0){const k=p(m,a);typeof k=="number"&&(O/=k),f.push({id:m,score:+O.toFixed(2)})}}return f.sort((m,y)=>{const R={id:m.id,chapter:h(m.id),number:i(m.id),value:0},O={id:y.id,chapter:h(y.id),number:i(y.id),value:0};function k(s){g(s.id)&&(s.value+=2e3),(b(s.id)||S(s.id))&&(s.value+=1e3),s.value+=s.chapter*1e4+s.number*10}function x(s,c){return s-c}function C(s,c){return c-s}k(R),k(O);let B=r.sort&&r.sort.score?x(m.score,y.score):C(m.score,y.score);return B!==0?B:r.sort&&r.sort.list?C(R.value,O.value):x(R.value,O.value)}),f}function U(e,d,u){let r,a;if($.exists(e)?(r=e,a=$.fragment(e)):(r=$.convertFragmentID(e),a=e),r===I.placeholder_id)return!1;const f=K(d,u);if((f==null?void 0:f.item)===r)return!0;for(const l of W(d,u))if(l.item===r||l.item===a)return!0;for(const l of L(d,u))if(l.item===r||l.item===a)return!0;return!1}function o(e){console.time("quest.estimate");const u=V.build({required:e},{});let r=0;for(const a in _){let f=function(l){const j=K(a,"JP");if(j&&u.hasOwnProperty(j.item))return++l;for(const N of W(a,"JP"))if(u.hasOwnProperty(N.item))return++l;for(const N of L(a,"JP"))if(u.hasOwnProperty(N.item))return++l;return l};if(r>=100)break;r=f(r)}return console.timeEnd("quest.estimate"),r}function A(e,d){return n(e)&&E(e).name[d]!==void 0}return{data:_,get:E,name:H,stamina:p,memoryPiece:K,drops:W,subdrops:L,isNormal:v,isHard:b,isVeryHard:g,isEvent:S,getChapter:h,getNumber:i,getMaxChapter:w,exists:n,build:M,build2:D,search:J,checkForItem:U,estimate:o,existsInRegion:A}})();class t{}T(t,"is_init"),T(t,"user_state"),T(t,"force_no_localstorage"),T(t,"projects",{}),T(t,"create_project_ignored_rarities",{});const G=(()=>{function _(){if(!W()){if(K()){localStorage.getItem(I.legacy_localstorage_key)?(console.log("importing old settings"),E()):localStorage.getItem(I.localstorage_key)===null?(console.log("init new user"),t.user_state=JSON.parse(JSON.stringify(I.default_user_state)),p()):(console.log("loading user from localstorage"),t.user_state=JSON.parse(localStorage.getItem(I.localstorage_key))),t.is_init=!0;return}console.warn("localstorage is not supported on this browser, using basic state"),t.user_state=JSON.parse(JSON.stringify(I.default_user_state)),t.is_init=!0}}function E(){var D;const n=JSON.parse(localStorage.getItem(I.legacy_localstorage_key));t.user_state=JSON.parse(JSON.stringify(I.default_user_state));for(const q in n.character){const J=n.character[q];t.user_state.character[q]={...J,id:q}}t.user_state.inventory=n.inventory;for(const q of n.projects){let J={};q.details.ignored_rarity&&(J=JSON.parse(JSON.stringify(q.details.ignored_rarity)),delete q.details.ignored_rarity),t.user_state.projects[q.date]={type:q.type,date:parseInt(q.date),priority:q.priority,details:{...q.details,ignored_rarities:J,...!q.details.memory_piece&&{memory_piece:0},...!q.details.pure_memory_piece&&{pure_memory_piece:0}},required:q.required}}t.user_state.settings.region=n.settings.region;let M={};n.settings.quest.ignored_rarity&&(M=JSON.parse(JSON.stringify(n.settings.quest.ignored_rarity)),delete n.settings.quest.ignored_rarity),t.user_state.settings.quest=n.settings.quest,t.user_state.settings.quest.ignored_rarities=M,(D=t.user_state.settings.quest.chapter)!=null&&D.max&&z.getMaxChapter()<n.settings.quest.chapter.max&&(t.user_state.settings.quest.chapter.max=z.getMaxChapter(),t.user_state.settings.quest.chapter.min&&t.user_state.settings.quest.chapter.min>t.user_state.settings.quest.chapter.max&&(t.user_state.settings.quest.chapter.min=t.user_state.settings.quest.chapter.max)),p(),localStorage.removeItem(I.legacy_localstorage_key)}function H(){return t.user_state||_(),t.user_state}function p(){if(!K()){console.log("local storage not supported, cant save");return}localStorage.setItem(I.localstorage_key,JSON.stringify(t.user_state)),console.log("saved user state",t.user_state)}function K(){return typeof Storage<"u"&&!t.force_no_localstorage}function W(){return t.is_init}function L(){return t.projects}function v(){return t.create_project_ignored_rarities}function b(){t.force_no_localstorage=!t.force_no_localstorage}const g=(()=>{function n(o){t.user_state.inventory=o,p()}function M(o,A){A<=0?delete t.user_state.inventory[o]:t.user_state.inventory[o]=A>=I.inventory.max.fragment?I.inventory.max.fragment:A,p()}function D(){return t.user_state.inventory}function q(o){return t.user_state.inventory[o]||0}function J(o,A){M(o,q(o)+A)}function U(o){delete t.user_state.inventory[o],p()}return{set:n,setAmount:M,get:D,getAmount:q,remove:U,addAmount:J}})(),S=(()=>{function n(o){t.user_state.character=o,p()}function M(){return t.user_state.character}function D(o,A,e){t.user_state.character={...t.user_state.character,[o]:t.user_state.character[o]||{id:o},[o]:{...t.user_state.character[o],rank:A,equipment:e}},p()}function q(o){return t.user_state.character[o]}function J(o){return t.user_state.character[o]!==void 0}function U(o){J(o)&&(delete t.user_state.character[o],p())}return{set:n,get:M,setCharacter:D,getCharacter:q,exists:J,remove:U}})(),h=(()=>{function n(e,d){t.user_state.settings={...t.user_state.settings,[e]:d},p()}function M(e){t.user_state.settings=e,p()}function D(){return t.user_state.settings}function q(){return t.user_state.settings.hide_content||!1}function J(e){n("hide_content",e)}function U(){return t.user_state.settings.auto_enable_projects||!1}function o(e){n("auto_enable_projects",e)}const A=(()=>{function e(){return t.user_state.settings.quest||(t.user_state.settings.quest={}),t.user_state.settings.quest}function d(){return e()}function u(s,c){const P=e();P.chapter={min:s,max:c,auto_max:c===z.getMaxChapter()},p()}function r(){return e().chapter}function a(s){const c=e();if(c.disabled_difficulty||(c.disabled_difficulty={}),c.disabled_difficulty[s]){delete c.disabled_difficulty[s],p();return}c.disabled_difficulty[s]=!0,p()}function f(){return e().disabled_difficulty}function l(s){var c;return((c=f())==null?void 0:c[s])||!1}function j(s){const c=e();c.item_filter=s,p()}function N(){return e().item_filter||[]}function m(s,c){const P=e();if(P.drop_buff||(P.drop_buff={}),c===1){delete P.drop_buff[s],p();return}P.drop_buff[s]=c,p()}function y(s){var P;return((P=e().drop_buff)==null?void 0:P[s])||1}function R(){const s=e();if(s.sort||(s.sort={}),s.sort.list){delete s.sort.list,p();return}s.sort.list=!0,p()}function O(){var c;return((c=e().sort)==null?void 0:c.list)||!1}function k(){const s=e();if(s.sort||(s.sort={}),s.sort.score){delete s.sort.score,p();return}s.sort.score=!0,p()}function x(){var c;return((c=e().sort)==null?void 0:c.score)||!1}function C(s){const c=e();if(c.ignored_rarities||(c.ignored_rarities={}),c.ignored_rarities[s]){delete c.ignored_rarities[s],p();return}c.ignored_rarities[s]=!0,p()}function B(s){var P;return((P=e().ignored_rarities)==null?void 0:P[s])||!1}return{get:d,setChapterRange:u,getChapterRange:r,disableDifficulty:a,getDisabledDifficulties:f,isDisabledDifficulty:l,setItemFilter:j,getItemFilter:N,setDropBuff:m,getDropBuff:y,toggleListSort:R,getListSort:O,toggleScoreSort:k,getScoreSort:x,ignoreRarity:C,isRarityIgnored:B}})();return{set:n,setAll:M,get:D,hideContent:q,setHideContent:J,isAutoEnableProjects:U,setAutoEnableProjects:o,quest:A}})(),i=(()=>{function n(o){t.user_state.projects=o,p()}function M(){return t.user_state.projects}function D(o){console.log("Add project"),t.user_state.projects[o.date||Date.now()]=o,p()}function q(o,A){t.user_state.projects[o]&&(t.user_state.projects[o]=A,p())}function J(o){delete t.user_state.projects[o],p()}function U(o,A={}){if(!t.user_state.projects[o.date])return;let e=A.consume?V.consume(o,g.get(),h.get().region,o.details.ignored_rarities):g.get();if(A.save&&o.type==="character"){const d=o.details.avatar_id,u=S.get();S.set({...u,[d]:{id:d,rank:o.details.end.rank,equipment:o.details.end.equipment}}),g.set(e),J(o.date);return}g.set(e),J(o.date)}return{set:n,get:M,add:D,replace:q,delete:J,complete:U}})(),w=(()=>{function n(D){t.user_state.settings.region=D,p()}function M(){return t.user_state.settings.region||"UNKNOWN"}return{set:n,get:M}})();return{init:_,get:H,save:p,isInit:W,_toggle_localstorage:b,getSessionProjects:L,getSessionIgnoredRarities:v,inventory:g,character:S,settings:h,projects:i,region:w}})();export{V as p,z as q,G as u};
